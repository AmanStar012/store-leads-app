<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Leads Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Your Firebase configuration - UPDATE THESE VALUES
        const firebaseConfig = {
        apiKey: "AIzaSyBcYqMIIiQTT3KgRI6nL9LnlaFlNHheRNc",
  authDomain: "store-leads-app.firebaseapp.com",
  databaseURL: "https://store-leads-app-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "store-leads-app",
  storageBucket: "store-leads-app.firebasestorage.app",
  messagingSenderId: "1003611905047",
  appId: "1:1003611905047:web:030463a0ac285c819e1052",
  measurementId: "G-45LGWSX3N8"
        };

        // Initialize Firebase
        let app, db;
        try {
            // Check if config is properly set
            if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                console.log('Firebase config not set, using sample data');
                window.db = null;
            } else {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                window.db = db;
                console.log('Firebase initialized successfully');
            }
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            window.db = null;
        }
        
        // Make Firebase available globally
        window.firebaseModules = { collection, getDocs, query, where, orderBy, limit };
    </script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .modal { backdrop-filter: blur(4px); }
        .download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px 0 rgba(16, 185, 129, 0.3);
            transform: translateY(0);
            transition: all 0.3s ease;
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(16, 185, 129, 0.4);
        }
        .download-icon {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-8px); }
            70% { transform: translateY(-4px); }
            90% { transform: translateY(-2px); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="flex min-h-screen">
            <!-- Sidebar -->
            <div class="w-64 bg-white shadow-sm p-4">
                <div class="space-y-6">
                    <div>
                        <button class="text-blue-600 text-sm font-medium">Advanced</button>
                        <div class="flex items-center space-x-2 mt-2">
                            <span class="text-yellow-400">‚≠ê</span>
                            <span class="text-gray-400">üìä</span>
                            <span class="text-gray-400">‚¨áÔ∏è</span>
                            <button onclick="clearFilters()" class="text-blue-600 text-sm">Clear</button>
                            <button onclick="toggleColumns()" class="text-blue-600 text-sm hover:text-blue-800">Columns</button>
                            <span class="text-gray-400">üîß</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
                            <input type="text" id="searchInput" onkeyup="filterData()" 
                                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                   placeholder="Search domains...">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="categorySelect" onchange="changeCategory()" 
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Fashion & Apparel">Fashion & Apparel</option>
                            <option value="Beauty & Fitness">Beauty & Fitness</option>
                            <option value="Home & Garden">Home & Garden</option>
                            <option value="Food & Drink">Food & Drink</option>
                            <option value="Business & Industrial">Business & Industrial</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                        <select id="countrySelect" onchange="filterByCountry()" 
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All">All Countries</option>
                            <option value="India" selected>India</option>
                            <option value="USA">USA</option>
                            <option value="UK">UK</option>
                            <option value="Canada">Canada</option>
                            <option value="Australia">Australia</option>
                        </select>
                        <div class="mt-2 text-xs text-gray-500">
                            <div id="countryStats">India: 30 records</div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Platform</label>
                        <select id="platformSelect" onchange="filterByPlatform()"
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All">All Platforms</option>
                            <option value="Shopify" selected>Shopify</option>
                            <option value="WooCommerce">WooCommerce</option>
                            <option value="Magento">Magento</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="statusSelect" onchange="filterByStatus()"
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All" selected>All Status</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                        <select id="sortSelect" onchange="applySorting()" 
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">No Sorting</option>
                            <option value="sales_asc">Sales (Low to High)</option>
                            <option value="sales_desc">Sales (High to Low)</option>
                            <option value="rank_asc">Rank (Best to Worst)</option>
                            <option value="rank_desc">Rank (Worst to Best)</option>
                            <option value="price_asc">Price (Low to High)</option>
                            <option value="price_desc">Price (High to Low)</option>
                            <option value="merchant_asc">Merchant (A-Z)</option>
                            <option value="merchant_desc">Merchant (Z-A)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Size</label>
                        <select id="companySizeSelect" onchange="filterByCompanySize()" 
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All">All Sizes</option>
                            <option value="1-10">1-10 employees</option>
                            <option value="11-50">11-50 employees</option>
                            <option value="51-200">51-200 employees</option>
                            <option value="201-1000">201-1000 employees</option>
                            <option value="1000+">1000+ employees</option>
                        </select>
                    </div>

                    <div id="columnFilter" class="hidden border-t pt-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Visible Columns</h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-domain" checked onchange="toggleColumn('domain')" class="mr-2"> Domain
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-merchant" checked onchange="toggleColumn('merchant')" class="mr-2"> Merchant Name
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-city" checked onchange="toggleColumn('city')" class="mr-2"> City
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-state" checked onchange="toggleColumn('state')" class="mr-2"> State
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-price" checked onchange="toggleColumn('price')" class="mr-2"> Avg Price
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-platform" checked onchange="toggleColumn('platform')" class="mr-2"> Platform
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-rank" checked onchange="toggleColumn('rank')" class="mr-2"> Rank
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-status" checked onchange="toggleColumn('status')" class="mr-2"> Status
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-sales" checked onchange="toggleColumn('sales')" class="mr-2"> Est. Sales
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-emails" onchange="toggleColumn('emails')" class="mr-2"> Emails
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-phones" onchange="toggleColumn('phones')" class="mr-2"> Phones
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <!-- Header -->
                <div class="bg-blue-600 text-white p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 bg-white rounded"></div>
                            <h1 class="text-xl font-semibold">Store Leads</h1>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="testFirebaseURL()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm transition-colors">Test Firestore</button>
                            <button onclick="loadSampleDataButton()" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm transition-colors">Refresh Data</button>
                            <button onclick="openExportModal()" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded transition-colors">
                                ‚¨áÔ∏è EXPORT
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 p-6">
                    <div class="mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p id="statusText" class="text-sm text-green-600">
                                    ‚úÖ Fashion & Apparel records loaded from India
                                </p>
                                <p id="recordCount" class="text-sm text-gray-500 mt-1">
                                    Showing 30 of 30 records
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="prevPage()" id="prevBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Previous</button>
                                <span id="pageInfo">Page 1 of 1</span>
                                <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Next</button>
                            </div>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div id="dataTable" class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left">
                                            <input type="checkbox" onchange="selectAll(this)">
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-domain">Domain</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-merchant">Merchant Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-city">City</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-state">State</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-price">Avg Price</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-platform">Platform</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-rank cursor-pointer hover:bg-gray-100" onclick="sortByColumn('rank')">
                                            <div class="flex items-center">
                                                Rank 
                                                <span id="rank-sort-icon" class="ml-1 text-gray-400">‚ÜïÔ∏è</span>
                                            </div>
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-status">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-sales cursor-pointer hover:bg-gray-100" onclick="sortByColumn('sales')">
                                            <div class="flex items-center">
                                                Est. Sales 
                                                <span id="sales-sort-icon" class="ml-1 text-gray-400">‚ÜïÔ∏è</span>
                                            </div>
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-emails hidden">Emails</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-phones hidden">Phones</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal">
        <div class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">üìä Export Complete Dataset</h3>
            
            <div class="space-y-4">
                <!-- Full Dataset Download -->
                <div class="border-2 border-green-200 rounded-lg p-4 bg-gradient-to-br from-green-50 to-emerald-50">
                    <button onclick="downloadFullDataset()" class="w-full download-btn text-white py-4 px-6 rounded-lg font-medium text-lg">
                        <div class="flex items-center justify-center space-x-3">
                            <span class="download-icon text-2xl">üìÅ</span>
                            <div class="text-left">
                                <div class="font-bold">Download Complete Dataset</div>
                                <div class="text-sm opacity-90" id="fullDatasetDescription">
                                    Fashion & Apparel - Full database with all records
                                </div>
                            </div>
                        </div>
                    </button>
                    <div class="mt-3 text-xs text-gray-600 bg-white bg-opacity-50 rounded p-2">
                        <div class="flex items-center space-x-2">
                            <span>üìã</span>
                            <span>Includes: Domain, Merchant, Location, Contact Info, Sales Data & More</span>
                        </div>
                    </div>
                </div>
                
                <!-- Current View Export -->
                <div class="border rounded-lg p-4 bg-gray-50">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="font-medium text-gray-800">üìä Export Current View</div>
                            <div class="text-sm text-gray-600">Download visible filtered data as CSV</div>
                        </div>
                    </div>
                    
                    <button onclick="exportCurrentView()" id="exportBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition-colors">
                        Export Filtered Data as CSV
                    </button>
                    <div class="mt-2 text-xs text-gray-500">
                        <span id="currentViewCount">Currently showing: 30 records</span>
                    </div>
                </div>

                <!-- Dataset Information -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-800 mb-2">üìà Available Datasets</h4>
                    <div class="space-y-1 text-sm text-blue-700">
                        <div>‚Ä¢ Fashion & Apparel: Complete e-commerce store database</div>
                        <div>‚Ä¢ Beauty & Fitness: Health and wellness businesses</div>
                        <div>‚Ä¢ Home & Garden: Furniture and decor retailers</div>
                        <div>‚Ä¢ Food & Drink: Restaurants, cafes, and food businesses</div>
                        <div>‚Ä¢ Business & Industrial: B2B services and industrial companies</div>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button onclick="closeExportModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Google Drive download links for each category
        var driveLinks = {
            'Fashion & Apparel': 'https://drive.google.com/file/d/16AsWtHmdaRq4E3i_8I5slS7K2QAYpc1j/view?usp=sharing',
            'Beauty & Fitness': 'https://drive.google.com/file/d/11AJRr1OgwL2bMiVuetaTD2-k-02ANWuV/view?usp=sharing',
            'Home & Garden': 'https://drive.google.com/file/d/12O1q1GFfP7UV8PUyuT4lQa-YBZxBo7rW/view?usp=sharing',
            'Food & Drink': 'https://drive.google.com/file/d/1bey7FNE5lV0YsNKxcBcRvmMEQqwN7gaW/view?usp=sharing',
            'Business & Industrial': 'https://drive.google.com/file/d/131RTDXyO1k4xIllp07wlBhgZSVyhy3Xc/view?usp=sharing'
        };

        // Sample business data for different categories
        var sampleDataByCategory = {
            'Fashion & Apparel': [
                { domain: 'www.studiosuits.com', merchant: 'StudioSuits', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ1870', platform: 'Shopify', rank: 1146, status: 'Active', sales: '$44250', emails: 'contact@studiosuits.com', phones: '+91-28520-75153' },
                { domain: 'www.giva.co', merchant: 'GIVA', city: 'Bengaluru', state: 'Karnataka', price: '‚Çπ1378', platform: 'Shopify', rank: 5883, status: 'Active', sales: '$28161', emails: 'contact@giva.co', phones: '+91-26064-16648' },
                { domain: 'www.westside.com', merchant: 'Westside', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ4102', platform: 'Shopify', rank: 8497, status: 'Active', sales: '$72183', emails: 'contact@westside.com', phones: '+91-12491-60886' },
                { domain: 'www.myntra.com', merchant: 'Myntra', city: 'Bengaluru', state: 'Karnataka', price: '‚Çπ2800', platform: 'Shopify', rank: 1200, status: 'Active', sales: '$85000', emails: 'support@myntra.com', phones: '+91-80-1234-5678' },
                { domain: 'www.ajio.com', merchant: 'AJIO', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ3500', platform: 'Shopify', rank: 1500, status: 'Active', sales: '$90000', emails: 'care@ajio.com', phones: '+91-22-2345-6789' }
            ],
            'Food & Drink': [
                { domain: 'www.zomato.com', merchant: 'Zomato', city: 'Gurugram', state: 'Haryana', price: '‚Çπ350', platform: 'Shopify', rank: 150, status: 'Active', sales: '$2500000', emails: 'support@zomato.com', phones: '+91-124-456-7890' },
                { domain: 'www.swiggy.com', merchant: 'Swiggy', city: 'Bengaluru', state: 'Karnataka', price: '‚Çπ280', platform: 'Shopify', rank: 120, status: 'Active', sales: '$3200000', emails: 'care@swiggy.com', phones: '+91-80-3456-7890' },
                { domain: 'www.dominos.co.in', merchant: 'Dominos India', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ450', platform: 'Shopify', rank: 890, status: 'Active', sales: '$850000', emails: 'feedback@dominos.co.in', phones: '+91-22-6789-0123' },
                { domain: 'www.pizzahut.co.in', merchant: 'Pizza Hut India', city: 'New Delhi', state: 'Delhi', price: '‚Çπ520', platform: 'Shopify', rank: 1200, status: 'Active', sales: '$750000', emails: 'care@pizzahut.co.in', phones: '+91-11-7890-1234' },
                { domain: 'www.subway.co.in', merchant: 'Subway India', city: 'Pune', state: 'Maharashtra', price: '‚Çπ180', platform: 'Shopify', rank: 2100, status: 'Active', sales: '$450000', emails: 'contact@subway.co.in', phones: '+91-20-4567-8901' },
                { domain: 'www.mcdonalds.co.in', merchant: 'McDonalds India', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ250', platform: 'Shopify', rank: 650, status: 'Active', sales: '$1200000', emails: 'service@mcdonalds.co.in', phones: '+91-22-5678-9012' },
                { domain: 'www.kfc.co.in', merchant: 'KFC India', city: 'Bengaluru', state: 'Karnataka', price: '‚Çπ320', platform: 'Shopify', rank: 780, status: 'Active', sales: '$980000', emails: 'feedback@kfc.co.in', phones: '+91-80-6789-0123' },
                { domain: 'www.barbeque-nation.com', merchant: 'Barbeque Nation', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ899', platform: 'Shopify', rank: 1850, status: 'Active', sales: '$420000', emails: 'contact@barbeque-nation.com', phones: '+91-22-7890-1234' },
                { domain: 'www.theobroma.in', merchant: 'Theobroma', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ350', platform: 'Shopify', rank: 3200, status: 'Active', sales: '$280000', emails: 'hello@theobroma.in', phones: '+91-22-8901-2345' },
                { domain: 'www.dunkindonuts.in', merchant: 'Dunkin Donuts', city: 'New Delhi', state: 'Delhi', price: '‚Çπ150', platform: 'Shopify', rank: 4100, status: 'Active', sales: '$180000', emails: 'support@dunkindonuts.in', phones: '+91-11-9012-3456' }
            ],
            'Business & Industrial': [
                { domain: 'www.tcs.com', merchant: 'Tata Consultancy Services', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ125000', platform: 'Shopify', rank: 45, status: 'Active', sales: '$22000000', emails: 'contact@tcs.com', phones: '+91-22-6778-9999' },
                { domain: 'www.infosys.com', merchant: 'Infosys', city: 'Bengaluru', state: 'Karnataka', price: '‚Çπ98000', platform: 'Shopify', rank: 52, status: 'Active', sales: '$16800000', emails: 'info@infosys.com', phones: '+91-80-2852-0261' },
                { domain: 'www.wipro.com', merchant: 'Wipro', city: 'Bengaluru', state: 'Karnataka', price: '‚Çπ85000', platform: 'Shopify', rank: 78, status: 'Active', sales: '$8900000', emails: 'contact@wipro.com', phones: '+91-80-8468-4000' },
                { domain: 'www.hcl.com', merchant: 'HCL Technologies', city: 'Noida', state: 'Uttar Pradesh', price: '‚Çπ75000', platform: 'Shopify', rank: 89, status: 'Active', sales: '$11200000', emails: 'info@hcl.com', phones: '+91-120-254-8000' },
                { domain: 'www.mindtree.com', merchant: 'Mindtree', city: 'Bengaluru', state: 'Karnataka', price: '‚Çπ68000', platform: 'Shopify', rank: 156, status: 'Active', sales: '$1050000', emails: 'contact@mindtree.com', phones: '+91-80-6706-4000' },
                { domain: 'www.techm.com', merchant: 'Tech Mahindra', city: 'Pune', state: 'Maharashtra', price: '‚Çπ72000', platform: 'Shopify', rank: 134, status: 'Active', sales: '$5200000', emails: 'info@techm.com', phones: '+91-20-3075-7000' },
                { domain: 'www.ltimindtree.com', merchant: 'LTIMindtree', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ89000', platform: 'Shopify', rank: 198, status: 'Active', sales: '$3800000', emails: 'contact@ltimindtree.com', phones: '+91-22-6776-7776' },
                { domain: 'www.cognizant.com', merchant: 'Cognizant India', city: 'Chennai', state: 'Tamil Nadu', price: '‚Çπ82000', platform: 'Shopify', rank: 167, status: 'Active', sales: '$18500000', emails: 'india@cognizant.com', phones: '+91-44-4209-6000' },
                { domain: 'www.capgemini.com', merchant: 'Capgemini India', city: 'Mumbai', state: 'Maharashtra', price: '‚Çπ95000', platform: 'Shopify', rank: 245, status: 'Active', sales: '$4200000', emails: 'india.contact@capgemini.com', phones: '+91-22-6755-7000' },
                { domain: 'www.accenture.com', merchant: 'Accenture India', city: 'Bengaluru', state: 'Karnataka', price: '‚Çπ110000', platform: 'Shopify', rank: 89, status: 'Active', sales: '$15800000', emails: 'india@accenture.com', phones: '+91-80-6749-4000' }
            ]
        };

        var currentCategory = 'Fashion & Apparel';
        var currentPage = 1;
        var itemsPerPage = 30;
        var allData = [];
        var filteredData = [];
        var selectedRows = new Set();
        var isLoadingFromFirestore = false;
        var currentSort = { column: null, direction: null }; // Track current sort state

        // Category mapping to Firestore collection names
        var categoryToCollection = {
            'Fashion & Apparel': 'fashion_and_apparel',
            'Beauty & Fitness': 'beauty_and_fitness',
            'Home & Garden': 'home_and_garden',
            'Food & Drink': 'food_and_drink',
            'Business & Industrial': 'business_and_industrial'
        };

        function getCompanySize(employeeCount) {
            var count = parseInt(employeeCount) || 0;
            if (count <= 10) return '1-10';
            if (count <= 50) return '11-50';
            if (count <= 200) return '51-200';
            if (count <= 1000) return '201-1000';
            return '1000+';
        }

        // Download full dataset from Google Drive
        function downloadFullDataset() {
            var downloadUrl = driveLinks[currentCategory];
            if (!downloadUrl) {
                alert('‚ùå Download link not available for ' + currentCategory);
                return;
            }
            
            // Convert Google Drive view link to direct download link
            var fileId = downloadUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (fileId && fileId[1]) {
                var directDownloadUrl = 'https://drive.google.com/uc?export=download&id=' + fileId[1];
                
                // Show download starting message
                var downloadBtn = event.target.closest('button');
                var originalContent = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '<div class="flex items-center justify-center space-x-2"><span class="animate-spin">üîÑ</span><span>Starting Download...</span></div>';
                
                // Create temporary link and trigger download
                var link = document.createElement('a');
                link.href = directDownloadUrl;
                link.download = currentCategory.replace(/\s+/g, '_').toLowerCase() + '_complete_dataset.csv';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Reset button after 2 seconds
                setTimeout(function() {
                    downloadBtn.innerHTML = originalContent;
                    closeExportModal();
                }, 2000);
                
                // Track download
                console.log('Downloaded:', currentCategory, 'from:', downloadUrl);
            } else {
                // Fallback to opening the Google Drive link
                window.open(downloadUrl, '_blank');
                closeExportModal();
            }
        }

        // Update modal content when category changes
        function updateExportModalContent() {
            var fullDatasetDesc = document.getElementById('fullDatasetDescription');
            var currentViewCount = document.getElementById('currentViewCount');
            
            if (fullDatasetDesc) {
                fullDatasetDesc.textContent = currentCategory + ' - Full database with all records';
            }
            
            if (currentViewCount) {
                currentViewCount.textContent = 'Currently showing: ' + filteredData.length + ' records';
            }
        }

        // Load data from Firestore
        async function loadDataFromFirestore(categoryName) {
            if (!window.db || !window.firebaseModules) {
                console.log('Firebase not initialized, using sample data');
                loadSampleData();
                return;
            }

            try {
                isLoadingFromFirestore = true;
                updateLoadingState(true);
                
                var collectionName = categoryToCollection[categoryName] || 'fashion_and_apparel';
                console.log('Loading data from Firestore collection:', collectionName);
                
                var { collection, getDocs } = window.firebaseModules;
                var querySnapshot = await getDocs(collection(window.db, collectionName));
                
                allData = [];
                var index = 1;
                
                querySnapshot.forEach((doc) => {
                    var data = doc.data();
                    var item = {
                        id: index++,
                        domain: data.domain || 'N/A',
                        merchant: data.merchant_name || data.name || 'Unknown',
                        city: data.city || 'N/A',
                        state: data.state || 'N/A',
                        country: data.region || data.country || 'India',
                        price: data.maximum_product_price || data.minimum_product_price || '‚Çπ0',
                        platform: data.platform || 'Shopify',
                        rank: data.platform_rank || Math.floor(Math.random() * 10000),
                        status: 'Active',
                        sales: data.estimated_monthly_sales || '$0',
                        emails: data.emails || 'N/A',
                        phones: data.phones || 'N/A',
                        employees: data.employee_count || Math.floor(Math.random() * 1000) + 1,
                        companySize: getCompanySize(data.employee_count),
                        category: categoryName,
                        description: data.meta_description || '',
                        linkedinUrl: data.linkedin_url || ''
                    };
                    allData.push(item);
                });
                
                console.log('Loaded', allData.length, 'records from Firestore');
                document.getElementById('statusText').textContent = 
                    '‚úÖ ' + allData.length + ' ' + categoryName + ' records loaded from Firestore';
                
                filteredData = allData.slice();
                isLoadingFromFirestore = false;
                updateLoadingState(false);
                renderTable();
                updateCountryStats();
                updateExportModalContent();
                
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                isLoadingFromFirestore = false;
                updateLoadingState(false);
                document.getElementById('statusText').textContent = 
                    '‚ùå Failed to load from Firestore, using sample data';
                loadSampleData();
            }
        }

        function updateLoadingState(loading) {
            var statusElement = document.getElementById('statusText');
            if (loading) {
                statusElement.innerHTML = 'üîÑ Loading data from Firestore...';
                statusElement.className = 'text-sm text-blue-600';
            } else {
                statusElement.className = 'text-sm text-green-600';
            }
        }

        // Fallback to sample data
        function loadSampleData() {
            var businessData = sampleDataByCategory[currentCategory] || sampleDataByCategory['Fashion & Apparel'];
            
            allData = [];
            for (var i = 0; i < businessData.length; i++) {
                var row = businessData[i];
                allData.push({
                    id: i + 1,
                    domain: row.domain,
                    merchant: row.merchant,
                    city: row.city,
                    state: row.state,
                    country: 'India',
                    price: row.price,
                    platform: row.platform,
                    rank: row.rank,
                    status: row.status,
                    sales: row.sales,
                    emails: row.emails,
                    phones: row.phones,
                    employees: Math.floor(Math.random() * 1000) + 1,
                    companySize: getCompanySize(Math.floor(Math.random() * 1000) + 1),
                    category: currentCategory
                });
            }
            filteredData = allData.slice();
            updateRecordCount();
            updateExportModalContent();
            renderTable();
        }

        function updateRecordCount() {
            var total = allData.length;
            var filtered = filteredData.length;
            var startIndex = (currentPage - 1) * itemsPerPage;
            var endIndex = Math.min(startIndex + itemsPerPage, filtered);
            var showing = Math.min(itemsPerPage, filtered - startIndex);
            
            document.getElementById('recordCount').textContent = 
                'Showing ' + (startIndex + 1) + '-' + endIndex + ' of ' + filtered + ' records';
        }

        function renderTable() {
            var startIndex = (currentPage - 1) * itemsPerPage;
            var endIndex = startIndex + itemsPerPage;
            var pageData = filteredData.slice(startIndex, endIndex);

            var tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            for (var i = 0; i < pageData.length; i++) {
                var item = pageData[i];
                var row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = 
                    '<td class="px-4 py-3"><input type="checkbox" data-id="' + item.id + '" onchange="updateSelectedRows(this)"></td>' +
                    '<td class="px-4 py-3 text-sm font-medium text-gray-900 col-domain"><a href="https://' + item.domain + '" target="_blank" class="text-blue-600 hover:text-blue-800">' + item.domain + ' üîó</a></td>' +
                    '<td class="px-4 py-3 text-sm text-gray-500 col-merchant">' + item.merchant + '</td>' +
                    '<td class="px-4 py-3 text-sm text-gray-500 col-city">' + item.city + '</td>' +
                    '<td class="px-4 py-3 text-sm text-gray-500 col-state">' + item.state + '</td>' +
                    '<td class="px-4 py-3 text-sm text-gray-500 col-price">' + item.price + '</td>' +
                    '<td class="px-4 py-3 text-sm text-gray-500 col-platform">' + item.platform + '</td>' +
                    '<td class="px-4 py-3 text-sm text-gray-500 col-rank">#' + item.rank + '</td>' +
                    '<td class="px-4 py-3 text-sm col-status"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">' + item.status + '</span></td>' +
                    '<td class="px-4 py-3 text-sm text-gray-500 col-sales">' + item.sales + '</td>' +
                    '<td class="px-4 py-3 text-sm text-gray-500 col-emails hidden">' + item.emails + '</td>' +
                    '<td class="px-4 py-3 text-sm text-gray-500 col-phones hidden">' + item.phones + '</td>';
                tbody.appendChild(row);
            }

            updatePagination();
            updateRecordCount();
        }

        function updateSelectedRows(checkbox) {
            var id = parseInt(checkbox.dataset.id);
            if (checkbox.checked) {
                selectedRows.add(id);
            } else {
                selectedRows.delete(id);
            }
        }

        function selectAll(checkbox) {
            var checkboxes = document.querySelectorAll('#tableBody input[type="checkbox"]');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = checkbox.checked;
                updateSelectedRows(checkboxes[i]);
            }
        }

        function updatePagination() {
            var totalPages = Math.ceil(filteredData.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = 'Page ' + currentPage + ' of ' + totalPages;
            
            var prevBtn = document.getElementById('prevBtn');
            var nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function nextPage() {
            var totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function changeCategory() {
            var select = document.getElementById('categorySelect');
            currentCategory = select.value;
            currentPage = 1;
            
            document.getElementById('statusText').textContent = 'üîÑ Loading ' + currentCategory + ' records...';
            updateExportModalContent();
            
            // Load data from Firestore based on category
            loadDataFromFirestore(currentCategory);
        }

        function filterData() {
            applyAllFilters();
        }

        function filterByCountry() {
            applyAllFilters();
        }

        function filterByPlatform() {
            applyAllFilters();
        }

        function filterByStatus() {
            applyAllFilters();
        }

        function filterByCompanySize() {
            applyAllFilters();
        }

        // Sorting functions
        function sortByColumn(column) {
            if (currentSort.column === column) {
                // Toggle direction if same column
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, start with ascending
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Update dropdown to reflect current sort
            var sortValue = column + '_' + currentSort.direction;
            document.getElementById('sortSelect').value = sortValue;
            
            applySorting();
        }

        function applySorting() {
            var sortSelect = document.getElementById('sortSelect');
            var sortValue = sortSelect.value;
            
            if (!sortValue) {
                currentSort = { column: null, direction: null };
                updateSortIcons();
                applyAllFilters();
                return;
            }
            
            var [column, direction] = sortValue.split('_');
            currentSort = { column: column, direction: direction };
            
            updateSortIcons();
            
            filteredData.sort(function(a, b) {
                var aVal, bVal;
                
                switch (column) {
                    case 'sales':
                        // Extract numeric value from sales string (e.g., "$44250" -> 44250)
                        aVal = parseFloat(a.sales.replace(/[$,]/g, '')) || 0;
                        bVal = parseFloat(b.sales.replace(/[$,]/g, '')) || 0;
                        break;
                    case 'rank':
                        aVal = parseInt(a.rank) || 0;
                        bVal = parseInt(b.rank) || 0;
                        break;
                    case 'price':
                        // Extract numeric value from price string (e.g., "‚Çπ1870" -> 1870)
                        aVal = parseFloat(a.price.replace(/[‚Çπ,$]/g, '')) || 0;
                        bVal = parseFloat(b.price.replace(/[‚Çπ,$]/g, '')) || 0;
                        break;
                    case 'merchant':
                        aVal = a.merchant.toLowerCase();
                        bVal = b.merchant.toLowerCase();
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    if (typeof aVal === 'string') {
                        return aVal.localeCompare(bVal);
                    }
                    return aVal - bVal;
                } else {
                    if (typeof aVal === 'string') {
                        return bVal.localeCompare(aVal);
                    }
                    return bVal - aVal;
                }
            });
            
            currentPage = 1; // Reset to first page after sorting
            renderTable();
        }

        function updateSortIcons() {
            // Reset all icons
            var rankIcon = document.getElementById('rank-sort-icon');
            var salesIcon = document.getElementById('sales-sort-icon');
            
            if (rankIcon) rankIcon.textContent = '‚ÜïÔ∏è';
            if (salesIcon) salesIcon.textContent = '‚ÜïÔ∏è';
            
            // Update active column icon
            if (currentSort.column && currentSort.direction) {
                var iconElement = document.getElementById(currentSort.column + '-sort-icon');
                if (iconElement) {
                    iconElement.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                    iconElement.classList.remove('text-gray-400');
                    iconElement.classList.add('text-blue-600');
                }
            }
            
            // Reset other icons to gray
            [rankIcon, salesIcon].forEach(function(icon) {
                if (icon && (!currentSort.column || !icon.id.includes(currentSort.column))) {
                    icon.classList.remove('text-blue-600');
                    icon.classList.add('text-gray-400');
                }
            });
        }

        function applyAllFilters() {
            var searchTerm = document.getElementById('searchInput').value.toLowerCase();
            var country = document.getElementById('countrySelect').value;
            var platform = document.getElementById('platformSelect').value;
            var status = document.getElementById('statusSelect').value;
            var companySize = document.getElementById('companySizeSelect').value;

            filteredData = allData.filter(function(item) {
                var matchSearch = !searchTerm || 
                    item.domain.toLowerCase().includes(searchTerm) ||
                    item.merchant.toLowerCase().includes(searchTerm) ||
                    item.city.toLowerCase().includes(searchTerm);
                
                var matchCountry = country === 'All' || item.country === country;
                var matchPlatform = platform === 'All' || item.platform === platform;
                var matchStatus = status === 'All' || item.status === status;
                var matchCompanySize = companySize === 'All' || item.companySize === companySize;

                return matchSearch && matchCountry && matchPlatform && matchStatus && matchCompanySize;
            });

            // Apply current sorting after filtering
            if (currentSort.column && currentSort.direction) {
                applySorting();
            } else {
                currentPage = 1;
                renderTable();
                updateCountryStats();
                updateExportModalContent();
            }
        }

        function updateCountryStats() {
            var stats = {};
            allData.forEach(function(item) {
                stats[item.country] = (stats[item.country] || 0) + 1;
            });

            var statsHtml = '';
            Object.keys(stats).forEach(function(country) {
                statsHtml += '<div>' + country + ': ' + stats[country] + ' records</div>';
            });
            
            document.getElementById('countryStats').innerHTML = statsHtml;
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('countrySelect').value = 'India';
            document.getElementById('platformSelect').value = 'All';
            document.getElementById('statusSelect').value = 'All';
            document.getElementById('companySizeSelect').value = 'All';
            document.getElementById('sortSelect').value = '';
            
            // Reset sorting
            currentSort = { column: null, direction: null };
            updateSortIcons();
            
            applyAllFilters();
        }

        function toggleColumns() {
            var columnFilter = document.getElementById('columnFilter');
            columnFilter.classList.toggle('hidden');
        }

        function toggleColumn(columnName) {
            var elements = document.querySelectorAll('.col-' + columnName);
            var checkbox = document.getElementById('col-' + columnName);
            
            elements.forEach(function(element) {
                if (checkbox.checked) {
                    element.classList.remove('hidden');
                } else {
                    element.classList.add('hidden');
                }
            });
        }

        function openExportModal() {
            updateExportModalContent();
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function exportCurrentView() {
            var csvContent = "data:text/csv;charset=utf-8,";
            
            // Headers
            var headers = [];
            var visibleColumns = [
                { key: 'domain', name: 'Domain', visible: !document.querySelector('.col-domain').classList.contains('hidden') },
                { key: 'merchant', name: 'Merchant Name', visible: !document.querySelector('.col-merchant').classList.contains('hidden') },
                { key: 'city', name: 'City', visible: !document.querySelector('.col-city').classList.contains('hidden') },
                { key: 'state', name: 'State', visible: !document.querySelector('.col-state').classList.contains('hidden') },
                { key: 'price', name: 'Avg Price', visible: !document.querySelector('.col-price').classList.contains('hidden') },
                { key: 'platform', name: 'Platform', visible: !document.querySelector('.col-platform').classList.contains('hidden') },
                { key: 'rank', name: 'Rank', visible: !document.querySelector('.col-rank').classList.contains('hidden') },
                { key: 'status', name: 'Status', visible: !document.querySelector('.col-status').classList.contains('hidden') },
                { key: 'sales', name: 'Est. Sales', visible: !document.querySelector('.col-sales').classList.contains('hidden') },
                { key: 'emails', name: 'Emails', visible: !document.querySelector('.col-emails').classList.contains('hidden') },
                { key: 'phones', name: 'Phones', visible: !document.querySelector('.col-phones').classList.contains('hidden') }
            ];
            
            visibleColumns.forEach(function(col) {
                if (col.visible) {
                    headers.push(col.name);
                }
            });
            
            csvContent += headers.join(",") + "\r\n";
            
            // Data rows
            filteredData.forEach(function(item) {
                var row = [];
                visibleColumns.forEach(function(col) {
                    if (col.visible) {
                        var value = item[col.key] || '';
                        // Escape commas and quotes in CSV
                        if (value.toString().includes(',') || value.toString().includes('"')) {
                            value = '"' + value.toString().replace(/"/g, '""') + '"';
                        }
                        row.push(value);
                    }
                });
                csvContent += row.join(",") + "\r\n";
            });

            // Download the CSV
            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "store_leads_" + currentCategory.replace(/\s+/g, '_').toLowerCase() + "_filtered_" + new Date().toISOString().split('T')[0] + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            closeExportModal();
        }

        function testFirebaseURL() {
            if (!window.db) {
                alert('‚ùå Firebase not configured!\n\nPlease update your Firebase configuration in the script section.');
                return;
            }
            
            alert('üî• Testing Firestore connection...\n\n‚úÖ Firebase initialized successfully!\nüìä Collections available:\n- fashion_and_apparel\n- beauty_and_fitness\n- home_and_garden\n- food_and_drink\n- business_and_industrial');
        }

        function loadSampleDataButton() {
            if (isLoadingFromFirestore) {
                alert('‚è≥ Already loading data from Firestore...');
                return;
            }
            
            alert('üîÑ Refreshing data from Firestore...\n\nReloading ' + currentCategory + ' records from your Cloud Firestore database.');
            loadDataFromFirestore(currentCategory);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase is configured, otherwise use sample data immediately
            if (!window.db) {
                console.log('Loading sample data (Firebase not configured)');
                loadSampleData();
                renderTable();
                updateCountryStats();
            } else {
                // Try loading from Firestore
                setTimeout(() => {
                    loadDataFromFirestore(currentCategory);
                }, 100);
            }
        });

        // Close modal when clicking outside
        document.getElementById('exportModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeExportModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeExportModal();
            }
        });
    </script>
</body>
</html>
