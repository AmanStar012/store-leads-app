<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Store Leads Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBcYqMIIiQTT3KgRI6nL9LnlaFlNHheRNc",
      authDomain: "store-leads-app.firebaseapp.com",
      databaseURL: "https://store-leads-app-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "store-leads-app",
      storageBucket: "store-leads-app.firebasestorage.app",
      messagingSenderId: "1003611905047",
      appId: "1:1003611905047:web:030463a0ac285c819e1052",
      measurementId: "G-45LGWSX3N8"
    };

    // Initialize Firebase
    let app, db;
    try {
      if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
        window.db = null;
      } else {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        window.db = db;
      }
    } catch (error) {
      window.db = null;
    }
    
    window.firebaseModules = { collection, getDocs };
  </script>

  <style>
    .loading { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .modal { backdrop-filter: blur(4px); }
    .download-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 15px 0 rgba(16, 185, 129, 0.3);
      transform: translateY(0);
      transition: all 0.3s ease;
    }
    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px 0 rgba(16, 185, 129, 0.4);
    }
    .download-icon { animation: bounce 2s infinite; }
    @keyframes bounce {
      0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
      40%, 43% { transform: translateY(-8px); }
      70% { transform: translateY(-4px); }
      90% { transform: translateY(-2px); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <div class="w-64 bg-white shadow-sm p-4">
        <div class="space-y-6">
          <div>
            <button class="text-blue-600 text-sm font-medium">Advanced</button>
            <div class="flex items-center space-x-2 mt-2">
              <span class="text-yellow-400">‚≠ê</span>
              <span class="text-gray-400">üìä</span>
              <span class="text-gray-400">‚¨áÔ∏è</span>
              <button onclick="clearFilters()" class="text-blue-600 text-sm">Clear</button>
              <button onclick="toggleColumns()" class="text-blue-600 text-sm hover:text-blue-800">Columns</button>
              <span class="text-gray-400">üîß</span>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
              <input
                type="text"
                id="searchInput"
                onkeyup="filterData()"
                class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Search domains..."
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
            <select
              id="countrySelect"
              onchange="changeCountry()"
              class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="India" selected>üáÆüá≥ India</option>
              <option value="USA">üá∫üá∏ USA</option>
              <option value="UAE">üá¶üá™ UAE</option>
            </select>
            <div class="mt-2 text-xs text-gray-500">
              <div id="countryStats">India: 30 records</div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
            <select
              id="categorySelect"
              onchange="changeCategory()"
              class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="Fashion & Apparel">Fashion & Apparel</option>
              <option value="Beauty & Fitness">Beauty & Fitness</option>
              <option value="Home & Garden">Home & Garden</option>
              <option value="Food & Drink">Food & Drink</option>
              <option value="Business & Industrial">Business & Industrial</option>
              <option value="Auto & Vehicles">Auto & Vehicles</option>
              <option value="Arts & Entertainment">Arts & Entertainment</option>
              <option value="Consumer Electronics">Consumer Electronics</option>
              <option value="Finance">Finance</option>
              <option value="Gifts & Special Events">Gifts & Special Events</option>
              <option value="Health">Health</option>
              <option value="Jobs & Education">Jobs & Education</option>
              <option value="Pets & Animals">Pets & Animals</option>
              <option value="Sports">Sports</option>
              <option value="Toys & Hobbies">Toys & Hobbies</option>
              <option value="Travel">Travel</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Platform</label>
            <select
              id="platformSelect"
              onchange="filterByPlatform()"
              class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="All">All Platforms</option>
              <option value="Shopify" selected>Shopify</option>
              <option value="WooCommerce">WooCommerce</option>
              <option value="Magento">Magento</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select
              id="statusSelect"
              onchange="filterByStatus()"
              class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="All" selected>All Status</option>
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
            <select
              id="sortSelect"
              onchange="applySorting()"
              class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">No Sorting</option>
              <option value="sales_asc">Sales (Low to High)</option>
              <option value="sales_desc">Sales (High to Low)</option>
              <option value="rank_asc">Rank (Best to Worst)</option>
              <option value="rank_desc">Rank (Worst to Best)</option>
              <option value="price_asc">Price (Low to High)</option>
              <option value="price_desc">Price (High to Low)</option>
              <option value="merchant_asc">Merchant (A-Z)</option>
              <option value="merchant_desc">Merchant (Z-A)</option>
            </select>
          </div>

          <div id="columnFilter" class="hidden border-t pt-4">
            <h3 class="text-sm font-medium text-gray-700 mb-3">Visible Columns</h3>
            <div class="space-y-2 max-h-64 overflow-y-auto">
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-domain" checked onchange="toggleColumn('domain')" class="mr-2"> Domain
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-merchant" checked onchange="toggleColumn('merchant')" class="mr-2"> Merchant Name
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-city" checked onchange="toggleColumn('city')" class="mr-2"> City
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-state" checked onchange="toggleColumn('state')" class="mr-2"> State
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-price" checked onchange="toggleColumn('price')" class="mr-2"> Avg Price
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-platform" checked onchange="toggleColumn('platform')" class="mr-2"> Platform
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-rank" checked onchange="toggleColumn('rank')" class="mr-2"> Rank
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-status" checked onchange="toggleColumn('status')" class="mr-2"> Status
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-sales" checked onchange="toggleColumn('sales')" class="mr-2"> Est. Sales
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-emails" onchange="toggleColumn('emails')" class="mr-2"> Emails
              </label>
              <label class="flex items-center text-sm">
                <input type="checkbox" id="col-phones" onchange="toggleColumn('phones')" class="mr-2"> Phones
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col">
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <div class="w-6 h-6 bg-white rounded"></div>
              <h1 class="text-xl font-semibold">Store Leads</h1>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="testFirebaseURL()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm transition-colors">Test Firestore</button>
              <button onclick="loadSampleDataButton()" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm transition-colors">Refresh Data</button>
              <button onclick="openExportModal()" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded transition-colors">‚¨áÔ∏è EXPORT</button>
            </div>
          </div>
        </div>

        <!-- Content -->
        <div class="flex-1 p-6">
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <div>
                <p id="statusText" class="text-sm text-green-600">‚úÖ Fashion & Apparel records loaded from India</p>
                <p id="recordCount" class="text-sm text-gray-500 mt-1">Showing 30 of 30 records</p>
              </div>
              <div class="flex items-center space-x-2">
                <button onclick="prevPage()" id="prevBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Previous</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Next</button>
              </div>
            </div>
          </div>

          <!-- Data Table -->
          <div id="dataTable" class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left">
                      <input type="checkbox" onchange="selectAll(this)">
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-domain">Domain</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-merchant">Merchant Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-city">City</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-state">State</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-price">Avg Price</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-platform">Platform</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-rank cursor-pointer hover:bg-gray-100" onclick="sortByColumn('rank')">
                      <div class="flex items-center">Rank <span id="rank-sort-icon" class="ml-1 text-gray-400">‚ÜïÔ∏è</span></div>
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-status">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-sales cursor-pointer hover:bg-gray-100" onclick="sortByColumn('sales')">
                      <div class="flex items-center">Est. Sales <span id="sales-sort-icon" class="ml-1 text-gray-400">‚ÜïÔ∏è</span></div>
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-emails hidden">Emails</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-phones hidden">Phones</th>
                  </tr>
                </thead>
                <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="exportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal">
    <div class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto">
      <h3 class="text-lg font-semibold mb-4 text-gray-800">üìä Export Complete Dataset</h3>
      <div class="space-y-4">
        <!-- Full Dataset Download -->
        <div class="border-2 border-green-200 rounded-lg p-4 bg-gradient-to-br from-green-50 to-emerald-50">
          <button onclick="downloadFullDataset()" class="w-full download-btn text-white py-4 px-6 rounded-lg font-medium text-lg">
            <div class="flex items-center justify-center space-x-3">
              <span class="download-icon text-2xl">üìÅ</span>
              <div class="text-left">
                <div class="font-bold">Download Complete Dataset</div>
                <div class="text-sm opacity-90" id="fullDatasetDescription">Fashion & Apparel - Full database with all records</div>
              </div>
            </div>
          </button>
          <div class="mt-3 text-xs text-gray-600 bg-white bg-opacity-50 rounded p-2">
            <div class="flex items-center space-x-2">
              <span>üìã</span>
              <span>Includes: Domain, Merchant, Location, Contact Info, Sales Data & More</span>
            </div>
          </div>
        </div>

        <!-- Current View Export -->
        <div class="border rounded-lg p-4 bg-gray-50">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="font-medium text-gray-800">üìä Export Current View</div>
              <div class="text-sm text-gray-600">Download visible filtered data as CSV</div>
            </div>
          </div>
          <button onclick="exportCurrentView()" id="exportBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition-colors">Export Filtered Data as CSV</button>
          <div class="mt-2 text-xs text-gray-500">
            <span id="currentViewCount">Currently showing: 30 records</span>
          </div>
        </div>

        <!-- Dataset Information -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h4 class="font-medium text-blue-800 mb-2">üìà Available Datasets</h4>
          <div class="space-y-1 text-sm text-blue-700">
            <div>‚Ä¢ Fashion & Apparel: Complete e-commerce store database</div>
            <div>‚Ä¢ Beauty & Fitness: Health and wellness businesses</div>
            <div>‚Ä¢ Home & Garden: Furniture and decor retailers</div>
            <div>‚Ä¢ Food & Drink: Restaurants, cafes, and food businesses</div>
            <div>‚Ä¢ Business & Industrial: B2B services and industrial companies</div>
            <div>‚Ä¢ Auto & Vehicles: Automotive dealers and vehicle services</div>
            <div>‚Ä¢ Arts & Entertainment: Creative and entertainment businesses</div>
            <div>‚Ä¢ Consumer Electronics: Electronics retailers and manufacturers</div>
            <div>‚Ä¢ Finance: Financial services and banking institutions</div>
            <div>‚Ä¢ Gifts & Special Events: Gift shops and event planning services</div>
            <div>‚Ä¢ Health: Healthcare providers and medical services</div>
            <div>‚Ä¢ Jobs & Education: Educational institutions and job platforms</div>
            <div>‚Ä¢ Pets & Animals: Pet care and animal-related businesses</div>
            <div>‚Ä¢ Sports: Sports equipment and fitness businesses</div>
            <div>‚Ä¢ Toys & Hobbies: Toy stores and hobby-related retailers</div>
            <div>‚Ä¢ Travel: Travel agencies and tourism services</div>
          </div>
        </div>
      </div>

      <div class="flex space-x-3 mt-6">
        <button onclick="closeExportModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400 transition-colors">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // --------- NEW: helper for currency-agnostic numeric sort ----------
    function toNumber(val) {
      if (val == null) return 0;
      const n = parseFloat(val.toString().replace(/[^0-9.]/g, ''));
      return isNaN(n) ? 0 : n;
    }

    // --------- Drive Links (added UAE block; fill with your links as needed) ----------
    var driveLinks = {
      'India': {
        'Fashion & Apparel': 'https://drive.google.com/file/d/16AsWtHmdaRq4E3i_8I5slS7K2QAYpc1j/view?usp=sharing',
        'Beauty & Fitness': 'https://drive.google.com/file/d/11AJRr1OgwL2bMiVuetaTD2-k-02ANWuV/view?usp=sharing',
        'Home & Garden': 'https://drive.google.com/file/d/12O1q1GFfP7UV8PUyuT4lQa-YBZxBo7rW/view?usp=sharing',
        'Food & Drink': 'https://drive.google.com/file/d/1bey7FNE5lV0YsNKxcBcRvmMEQqwN7gaW/view?usp=sharing',
        'Business & Industrial': 'https://drive.google.com/file/d/131RTDXyO1k4xIllp07wlBhgZSVyhy3Xc/view?usp=sharing',
        'Auto & Vehicles': 'https://drive.google.com/file/d/1oQFOUryJ6_uH0HpLI4Ee_9JwBu2hRMlM/view?usp=sharing',
        'Arts & Entertainment': 'https://drive.google.com/file/d/1BHNSlI88wAGATvt42S6mZScpSPeRNEf-/view?usp=sharing',
        'Consumer Electronics': 'https://drive.google.com/file/d/1hkmmfG4vaceCrHZmuU7BRfPhz0mfKVul/view?usp=sharing',
        'Finance': 'https://drive.google.com/file/d/1fHajih_Od8YWvXN-veQWCjpXba-zg_y7/view?usp=sharing',
        'Gifts & Special Events': 'https://drive.google.com/file/d/1sCzTurC2xY4lkpxB_e0Y8DtwZqYn2IuC/view?usp=sharing',
        'Health': 'https://drive.google.com/file/d/1WOQoVnHN5sofp_Rt0HYH1Vt4vfHvLQJc/view?usp=sharing',
        'Jobs & Education': 'https://drive.google.com/file/d/1yhlVnm5neE0ylBmwM9GBV-rcTAK2zmch/view?usp=sharing',
        'Pets & Animals': 'https://drive.google.com/file/d/1wdfUPL8wO5AQFhsod9eVeYrhGkvmtpAX/view?usp=sharing',
        'Sports': 'https://drive.google.com/file/d/1KtQtC-yXDPAeViJF0Mgra5hX4PKlPApu/view?usp=sharing',
        'Toys & Hobbies': 'https://drive.google.com/file/d/1tbaAfHcvURfdovUqUD0iguTmvenxnbeT/view?usp=sharing',
        'Travel': 'https://drive.google.com/file/d/1wUnF3B79n1r5DSB9KGcV3zoxGw5Nx3Tf/view?usp=sharing'
      },
      'USA': {
        'Fashion & Apparel': 'https://drive.google.com/file/d/1pIIioJwd-zg90WFK-jkCL908v7wOYoCp/view?usp=sharing',
        'Beauty & Fitness': 'https://drive.google.com/file/d/1zDjjupAUvRgrt_95REUX2Ru2zkPnYP3p/view?usp=sharing',
        'Home & Garden': 'https://drive.google.com/file/d/1mI_FN-cZp6cO6Ehk7EECgnGSHYGRiMno/view?usp=sharing',
        'Food & Drink': 'https://drive.google.com/file/d/17MYHLB-r_LYkj8-mdm9zeSBAW59SVGvq/view?usp=sharing',
        'Business & Industrial': 'https://drive.google.com/file/d/1TplGk_mEe3Z6Q2yt9q8R-E4a5yUbmxo8/view?usp=sharing',
        'Auto & Vehicles': 'https://drive.google.com/file/d/1ZcDmaKUNGGgefgq5jhQRH0yB03FtJge0/view?usp=sharing',
        'Arts & Entertainment': 'https://drive.google.com/file/d/1z9YbKmLSXoQEgJtKZOpt594S38U05Zgp/view?usp=sharing',
        'Consumer Electronics': 'https://drive.google.com/file/d/1ykwEDddBS1lPQfQuGzQlPcG2WJIU2GPG/view?usp=sharing',
        'Finance': 'https://drive.google.com/file/d/18pmcbMBqKiw3Nri_bJzBrpwN6AEdY-mQ/view?usp=sharing',
        'Gifts & Special Events': 'https://drive.google.com/file/d/1t9faU3RTnQvSaDvkatTk79OtsXzBiqA_/view?usp=sharing',
        'Health': 'https://drive.google.com/file/d/1d3EgpbqABtSCIZyy7rkYNOtyh-Ynq9-_/view?usp=sharing',
        'Jobs & Education': 'https://drive.google.com/file/d/1M7jeroqb15ONw0t8IyqmtD8hvQiaqx0B/view?usp=sharing',
        'Pets & Animals': 'https://drive.google.com/file/d/1BS8egFWgFuO-8n4WOheJYiCYDGh-kwSk/view?usp=sharing',
        'Sports': 'https://drive.google.com/file/d/1vcc3nYrcwIPbyndgXJWGK-K8HbE7SQD6/view?usp=sharing',
        'Toys & Hobbies': 'https://drive.google.com/file/d/16GDHsNUTYWBnEhGjG-Yk5zFeEblvVJ6Y/view?usp=sharing',
        'Travel': 'https://drive.google.com/file/d/1qOyAcYC-giwPXB97z7pVGQ8K9FPIeEyY/view?usp=sharing'
      },
      'UAE': {
        'Fashion & Apparel': 'https://drive.google.com/file/d/1dhgHFu4N0IYF0elxWaoNr2YrryywgiJ0/view?usp=sharing',
        'Beauty & Fitness': 'https://drive.google.com/file/d/1GiiSNdKEWoQsLzNafvxXMoUBK7kXerD4/view?usp=sharing',
        'Home & Garden': 'https://drive.google.com/file/d/1gvcjzBN63b-28BDv1GJwdgXAju7La9yY/view?usp=sharing',
        'Food & Drink': 'https://drive.google.com/file/d/1GyRiS--CBydzZjPiJe5PCC6gECIsvr2w/view?usp=sharing',
        'Business & Industrial': 'https://drive.google.com/file/d/1z-FDfvIh7yKifE3Bsm9RZooW-IxFqn3O/view?usp=sharing',
        'Auto & Vehicles': 'https://drive.google.com/file/d/1A3Jn_6XmfkbmL_FgZasYHiAzfp4MR28p/view?usp=sharing',
        'Arts & Entertainment': 'https://drive.google.com/file/d/1e0ghzMb_LOrhNSS171GTYfdtnzbC9xSz/view?usp=sharing',
        'Consumer Electronics': 'https://drive.google.com/file/d/1WzGD99NNC6bitabM6uOFO7XU8Ewzbky-/view?usp=sharing',
        'Finance': 'https://drive.google.com/file/d/1x2j358GmVu5GOiY5xMQd_gE5nvhX2pju/view?usp=sharing',
        'Health': 'https://drive.google.com/file/d/1_uTDh1pRo37xbVCOLyg6fTbHKlQUxv68/view?usp=sharing',
        'Jobs & Education': 'https://drive.google.com/file/d/1wBzEEih_cDJF6afjYXaG6SgmEdx-U4Ym/view?usp=sharing',
        'Pets & Animals': 'https://drive.google.com/file/d/1BhqbVuxijM6kO5iNcbE38kt_fHHOnX9m/view?usp=sharing',
        'Sports': 'https://drive.google.com/file/d/1X8GeNPtfteZ4NXWgM2TFnEJ-B8XJ-teX/view?usp=sharing',
        'Toys & Hobbies': 'https://drive.google.com/file/d/12a3GzSIymFgh-RBWzyY29N83Ud-DWEnq/view?usp=sharing',
        'Travel': 'https://drive.google.com/file/d/12xOEHo49ZSdO4zYwxL4ZdLo63MMBXPsm/view?usp=sharing'
      }
    };

    var currentCountry = 'India';
    var currentCategory = 'Fashion & Apparel';
    var currentPage = 1;
    var itemsPerPage = 30;
    var allData = [];
    var filteredData = [];
    var selectedRows = new Set();
    var isLoadingFromFirestore = false;
    var currentSort = { column: null, direction: null };

    // --------- Firestore collection map (added UAE) ----------
    var categoryToCollection = {
      'India': {
        'Fashion & Apparel': 'fashion_and_apparel',
        'Beauty & Fitness': 'beauty_and_fitness',
        'Home & Garden': 'home_and_garden',
        'Food & Drink': 'food_and_drink',
        'Business & Industrial': 'business_and_industrial',
        'Auto & Vehicles': 'auto_and_vehicles',
        'Arts & Entertainment': 'arts_and_entertainment',
        'Consumer Electronics': 'consumer_electronics',
        'Finance': 'finance',
        'Gifts & Special Events': 'gifts_and_special_events',
        'Health': 'health',
        'Jobs & Education': 'jobs_and_education',
        'Pets & Animals': 'pets_and_animals',
        'Sports': 'sports',
        'Toys & Hobbies': 'toys_and_hobbies',
        'Travel': 'travel'
      },
      'USA': {
        'Fashion & Apparel': 'fashion_and_apparel_usa',
        'Beauty & Fitness': 'beauty_and_fitness_usa',
        'Home & Garden': 'home_and_garden_usa',
        'Food & Drink': 'food_and_drink_usa',
        'Business & Industrial': 'business_and_industrial_usa',
        'Auto & Vehicles': 'auto_and_vehicles_usa',
        'Arts & Entertainment': 'arts_and_entertainment_usa',
        'Consumer Electronics': 'consumer_electronics_usa',
        'Finance': 'finance_usa',
        'Gifts & Special Events': 'gifts_and_special_events_usa',
        'Health': 'health_usa',
        'Jobs & Education': 'jobs_and_education_usa',
        'Pets & Animals': 'pets_and_animals_usa',
        'Sports': 'sports_usa',
        'Toys & Hobbies': 'toys_and_hobbies_usa',
        'Travel': 'travel_usa'
      },
      'UAE': {
        'Fashion & Apparel': 'fashion_and_apparel_uae',
        'Beauty & Fitness': 'beauty_and_fitness_uae',
        'Home & Garden': 'home_and_garden_uae',
        'Food & Drink': 'food_and_drink_uae',
        'Business & Industrial': 'business_and_industrial_uae',
        'Auto & Vehicles': 'auto_and_vehicles_uae',
        'Arts & Entertainment': 'arts_and_entertainment_uae',
        'Consumer Electronics': 'consumer_electronics_uae',
        'Finance': 'finance_uae',
        'Health': 'health_uae',
        'Jobs & Education': 'jobs_and_education_uae',
        'Pets & Animals': 'pets_and_animals_uae',
        'Sports': 'sports_uae',
        'Toys & Hobbies': 'toys_and_hobbies_uae',
        'Travel': 'travel_uae'
      }
    };

    function getCompanySize(employeeCount) {
      var count = parseInt(employeeCount) || 0;
      if (count <= 10) return '1-10';
      if (count <= 50) return '11-50';
      if (count <= 200) return '51-200';
      if (count <= 1000) return '201-1000';
      return '1000+';
    }

    function downloadFullDataset() {
      var downloadUrl = driveLinks[currentCountry] && driveLinks[currentCountry][currentCategory];
      if (!downloadUrl) {
        alert('‚ùå Download link not available for ' + currentCategory + ' in ' + currentCountry);
        return;
      }
      var fileId = downloadUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
      if (fileId && fileId[1]) {
        var directDownloadUrl = 'https://drive.google.com/uc?export=download&id=' + fileId[1];
        var downloadBtn = event.target.closest('button');
        var originalContent = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<div class="flex items-center justify-center space-x-2"><span class="animate-spin">üîÑ</span><span>Starting Download...</span></div>';
        var link = document.createElement('a');
        link.href = directDownloadUrl;
        link.download = currentCountry.toLowerCase() + '_' + currentCategory.replace(/\s+/g, '_').toLowerCase() + '_complete_dataset.csv';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(function() {
          downloadBtn.innerHTML = originalContent;
          closeExportModal();
        }, 2000);
      } else {
        alert('‚ùå Download link not available for ' + currentCategory + ' in ' + currentCountry);
      }
    }

    function updateExportModalContent() {
      var fullDatasetDesc = document.getElementById('fullDatasetDescription');
      var currentViewCount = document.getElementById('currentViewCount');
      if (fullDatasetDesc) {
        fullDatasetDesc.textContent = currentCategory + ' (' + currentCountry + ') - Full database with all records';
      }
      if (currentViewCount) {
        currentViewCount.textContent = 'Currently showing: ' + filteredData.length + ' records';
      }
    }

    async function loadDataFromFirestore(countryName, categoryName) {
      if (!window.db || !window.firebaseModules) {
        allData = [];
        filteredData = [];
        renderTable();
        return;
      }

      try {
        isLoadingFromFirestore = true;
        updateLoadingState(true);

        var collectionName = categoryToCollection[countryName] && categoryToCollection[countryName][categoryName];
        if (!collectionName) {
          throw new Error('Collection not found for ' + countryName + ' - ' + categoryName);
        }

        var { collection, getDocs } = window.firebaseModules;
        var querySnapshot = await getDocs(collection(window.db, collectionName));

        allData = [];
        var index = 1;

        querySnapshot.forEach((doc) => {
          var data = doc.data();
          var item = {
            id: index++,
            domain: data.domain || 'N/A',
            merchant: data.merchant_name || data.name || 'Unknown',
            city: data.city || 'N/A',
            state: data.state || 'N/A',
            country: countryName,
            // AED-friendly defaults
            price: data.maximum_product_price || data.minimum_product_price ||
                   (countryName === 'USA' ? '$0' : countryName === 'UAE' ? 'AED 0' : '‚Çπ0'),
            platform: data.platform || 'Shopify',
            rank: data.platform_rank || Math.floor(Math.random() * 10000),
            status: 'Active',
            sales: data.estimated_monthly_sales ||
                   (countryName === 'USA' ? '$0' : countryName === 'UAE' ? 'AED 0' : '‚Çπ0'),
            emails: data.emails || 'N/A',
            phones: data.phones || 'N/A',
            employees: data.employee_count || Math.floor(Math.random() * 1000) + 1,
            companySize: getCompanySize(data.employee_count),
            category: categoryName,
            description: data.meta_description || '',
            linkedinUrl: data.linkedin_url || ''
          };
          allData.push(item);
        });

        var countryFlag = (countryName === 'USA') ? 'üá∫üá∏' : (countryName === 'UAE') ? 'üá¶üá™' : 'üáÆüá≥';
        document.getElementById('statusText').textContent =
          '‚úÖ ' + allData.length + ' ' + categoryName + ' records loaded from ' + countryFlag + ' ' + countryName;

        filteredData = allData.slice();
        isLoadingFromFirestore = false;
        updateLoadingState(false);
        renderTable();
        updateCountryStats();
        updateExportModalContent();
      } catch (error) {
        isLoadingFromFirestore = false;
        updateLoadingState(false);
        document.getElementById('statusText').innerHTML =
          '‚ùå Failed to load ' + categoryName + ' data from ' + countryName;
        document.getElementById('statusText').className = 'text-sm text-red-600';
        allData = [];
        filteredData = [];
        renderTable();
        updateRecordCount();
        updateExportModalContent();
      }
    }

    function updateLoadingState(loading) {
      var statusElement = document.getElementById('statusText');
      if (loading) {
        statusElement.innerHTML = 'üîÑ Loading data from Firestore...';
        statusElement.className = 'text-sm text-blue-600';
      } else {
        statusElement.className = 'text-sm text-green-600';
      }
    }

    function updateRecordCount() {
      var total = allData.length;
      var filtered = filteredData.length;
      var startIndex = (currentPage - 1) * itemsPerPage;
      var endIndex = Math.min(startIndex + itemsPerPage, filtered);
      if (filtered === 0) {
        document.getElementById('recordCount').textContent = 'Showing 0 of 0 records';
        return;
      }
      document.getElementById('recordCount').textContent =
        'Showing ' + (startIndex + 1) + '-' + endIndex + ' of ' + filtered + ' records';
    }

    function renderTable() {
      var startIndex = (currentPage - 1) * itemsPerPage;
      var endIndex = startIndex + itemsPerPage;
      var pageData = filteredData.slice(startIndex, endIndex);

      var tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      for (var i = 0; i < pageData.length; i++) {
        var item = pageData[i];
        var row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML =
          '<td class="px-4 py-3"><input type="checkbox" data-id="' + item.id + '" onchange="updateSelectedRows(this)"></td>' +
          '<td class="px-4 py-3 text-sm font-medium text-gray-900 col-domain"><a href="https://' + item.domain + '" target="_blank" class="text-blue-600 hover:text-blue-800">' + item.domain + ' üîó</a></td>' +
          '<td class="px-4 py-3 text-sm text-gray-500 col-merchant">' + item.merchant + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-500 col-city">' + item.city + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-500 col-state">' + item.state + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-500 col-price">' + item.price + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-500 col-platform">' + item.platform + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-500 col-rank">#' + item.rank + '</td>' +
          '<td class="px-4 py-3 text-sm col-status"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">' + item.status + '</span></td>' +
          '<td class="px-4 py-3 text-sm text-gray-500 col-sales">' + item.sales + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-500 col-emails hidden">' + item.emails + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-500 col-phones hidden">' + item.phones + '</td>';
        tbody.appendChild(row);
      }

      updatePagination();
      updateRecordCount();
    }

    function updateSelectedRows(checkbox) {
      var id = parseInt(checkbox.dataset.id);
      if (checkbox.checked) selectedRows.add(id);
      else selectedRows.delete(id);
    }

    function selectAll(checkbox) {
      var checkboxes = document.querySelectorAll('#tableBody input[type="checkbox"]');
      for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = checkbox.checked;
        updateSelectedRows(checkboxes[i]);
      }
    }

    function updatePagination() {
      var totalPages = Math.ceil((filteredData.length || 1) / itemsPerPage);
      document.getElementById('pageInfo').textContent = 'Page ' + currentPage + ' of ' + totalPages;
      var prevBtn = document.getElementById('prevBtn');
      var nextBtn = document.getElementById('nextBtn');
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
      prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
      prevBtn.classList.toggle('cursor-not-allowed', prevBtn.disabled);
      nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
      nextBtn.classList.toggle('cursor-not-allowed', nextBtn.disabled);
    }

    function nextPage() {
      var totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    }

    function changeCountry() {
      var select = document.getElementById('countrySelect');
      currentCountry = select.value;
      currentPage = 1;
      var countryFlag = currentCountry === 'USA' ? 'üá∫üá∏' : (currentCountry === 'UAE' ? 'üá¶üá™' : 'üáÆüá≥');
      document.getElementById('statusText').textContent =
        'üîÑ Loading ' + currentCategory + ' records from ' + countryFlag + ' ' + currentCountry + '...';
      updateExportModalContent();
      loadDataFromFirestore(currentCountry, currentCategory);
    }

    function changeCategory() {
      var select = document.getElementById('categorySelect');
      currentCategory = select.value;
      currentPage = 1;
      var countryFlag = currentCountry === 'USA' ? 'üá∫üá∏' : (currentCountry === 'UAE' ? 'üá¶üá™' : 'üáÆüá≥');
      document.getElementById('statusText').textContent =
        'üîÑ Loading ' + currentCategory + ' records from ' + countryFlag + ' ' + currentCountry + '...';
      updateExportModalContent();
      loadDataFromFirestore(currentCountry, currentCategory);
    }

    function filterData() { applyAllFilters(); }
    function filterByPlatform() { applyAllFilters(); }
    function filterByStatus() { applyAllFilters(); }
    function filterByCompanySize() { applyAllFilters(); }

    function sortByColumn(column) {
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      var sortValue = column + '_' + currentSort.direction;
      document.getElementById('sortSelect').value = sortValue;
      applySorting();
    }

    function applySorting() {
      var sortSelect = document.getElementById('sortSelect');
      var sortValue = sortSelect.value;
      if (!sortValue) {
        currentSort = { column: null, direction: null };
        updateSortIcons();
        applyAllFilters();
        return;
      }
      var [column, direction] = sortValue.split('_');
      currentSort = { column: column, direction: direction };
      updateSortIcons();

      filteredData.sort(function(a, b) {
        var aVal, bVal;
        switch (column) {
          case 'sales':
            aVal = toNumber(a.sales);
            bVal = toNumber(b.sales);
            break;
          case 'rank':
            aVal = parseInt(a.rank) || 0;
            bVal = parseInt(b.rank) || 0;
            break;
          case 'price':
            aVal = toNumber(a.price);
            bVal = toNumber(b.price);
            break;
          case 'merchant':
            aVal = (a.merchant || '').toLowerCase();
            bVal = (b.merchant || '').toLowerCase();
            break;
          default:
            return 0;
        }
        if (direction === 'asc') {
          if (typeof aVal === 'string') return aVal.localeCompare(bVal);
          return aVal - bVal;
        } else {
          if (typeof aVal === 'string') return bVal.localeCompare(aVal);
          return bVal - aVal;
        }
      });

      currentPage = 1;
      renderTable();
    }

    function updateSortIcons() {
      var rankIcon = document.getElementById('rank-sort-icon');
      var salesIcon = document.getElementById('sales-sort-icon');
      if (rankIcon) rankIcon.textContent = '‚ÜïÔ∏è';
      if (salesIcon) salesIcon.textContent = '‚ÜïÔ∏è';

      if (currentSort.column && currentSort.direction) {
        var iconElement = document.getElementById(currentSort.column + '-sort-icon');
        if (iconElement) {
          iconElement.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
          iconElement.classList.remove('text-gray-400');
          iconElement.classList.add('text-blue-600');
        }
      }
      [rankIcon, salesIcon].forEach(function(icon) {
        if (icon && (!currentSort.column || !icon.id.includes(currentSort.column))) {
          icon.classList.remove('text-blue-600');
          icon.classList.add('text-gray-400');
        }
      });
    }

    function applyAllFilters() {
      var searchTerm = document.getElementById('searchInput').value.toLowerCase();
      var platform = document.getElementById('platformSelect').value;
      var status = document.getElementById('statusSelect').value;
      var companySize = document.getElementById('companySizeSelect').value;

      filteredData = allData.filter(function(item) {
        var matchSearch = !searchTerm ||
          (item.domain || '').toLowerCase().includes(searchTerm) ||
          (item.merchant || '').toLowerCase().includes(searchTerm) ||
          (item.city || '').toLowerCase().includes(searchTerm);

        var matchPlatform = platform === 'All' || item.platform === platform;
        var matchStatus = status === 'All' || item.status === status;
        var matchCompanySize = companySize === 'All' || item.companySize === companySize;

        return matchSearch && matchPlatform && matchStatus && matchCompanySize;
      });

      if (currentSort.column && currentSort.direction) {
        applySorting();
      } else {
        currentPage = 1;
        renderTable();
        updateCountryStats();
        updateExportModalContent();
      }
    }

    function updateCountryStats() {
      var stats = {};
      allData.forEach(function(item) {
        stats[item.country] = (stats[item.country] || 0) + 1;
      });
      var statsHtml = '';
      Object.keys(stats).forEach(function(country) {
        var flag = country === 'USA' ? 'üá∫üá∏' : (country === 'UAE' ? 'üá¶üá™' : 'üáÆüá≥');
        statsHtml += '<div>' + flag + ' ' + country + ': ' + stats[country] + ' records</div>';
      });
      document.getElementById('countryStats').innerHTML = statsHtml || '<div>No records</div>';
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('platformSelect').value = 'All';
      document.getElementById('statusSelect').value = 'All';
      document.getElementById('companySizeSelect').value = 'All';
      document.getElementById('sortSelect').value = '';
      currentSort = { column: null, direction: null };
      updateSortIcons();
      applyAllFilters();
    }

    function toggleColumns() {
      var columnFilter = document.getElementById('columnFilter');
      columnFilter.classList.toggle('hidden');
    }

    function toggleColumn(columnName) {
      var elements = document.querySelectorAll('.col-' + columnName);
      var checkbox = document.getElementById('col-' + columnName);
      elements.forEach(function(element) {
        if (checkbox.checked) element.classList.remove('hidden');
        else element.classList.add('hidden');
      });
    }

    function openExportModal() {
      updateExportModalContent();
      document.getElementById('exportModal').classList.remove('hidden');
    }

    function closeExportModal() {
      document.getElementById('exportModal').classList.add('hidden');
    }

    function exportCurrentView() {
      var csvContent = "data:text/csv;charset=utf-8,";
      var headers = [];
      var visibleColumns = [
        { key: 'domain', name: 'Domain', visible: !document.querySelector('.col-domain').classList.contains('hidden') },
        { key: 'merchant', name: 'Merchant Name', visible: !document.querySelector('.col-merchant').classList.contains('hidden') },
        { key: 'city', name: 'City', visible: !document.querySelector('.col-city').classList.contains('hidden') },
        { key: 'state', name: 'State', visible: !document.querySelector('.col-state').classList.contains('hidden') },
        { key: 'price', name: 'Avg Price', visible: !document.querySelector('.col-price').classList.contains('hidden') },
        { key: 'platform', name: 'Platform', visible: !document.querySelector('.col-platform').classList.contains('hidden') },
        { key: 'rank', name: 'Rank', visible: !document.querySelector('.col-rank').classList.contains('hidden') },
        { key: 'status', name: 'Status', visible: !document.querySelector('.col-status').classList.contains('hidden') },
        { key: 'sales', name: 'Est. Sales', visible: !document.querySelector('.col-sales').classList.contains('hidden') },
        { key: 'emails', name: 'Emails', visible: !document.querySelector('.col-emails').classList.contains('hidden') },
        { key: 'phones', name: 'Phones', visible: !document.querySelector('.col-phones').classList.contains('hidden') }
      ];
      visibleColumns.forEach(function(col) { if (col.visible) headers.push(col.name); });
      csvContent += headers.join(",") + "\r\n";

      filteredData.forEach(function(item) {
        var row = [];
        visibleColumns.forEach(function(col) {
          if (col.visible) {
            var value = item[col.key] || '';
            if (value.toString().includes(',') || value.toString().includes('"')) {
              value = '"' + value.toString().replace(/"/g, '""') + '"';
            }
            row.push(value);
          }
        });
        csvContent += row.join(",") + "\r\n";
      });

      var encodedUri = encodeURI(csvContent);
      var link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute(
        "download",
        "store_leads_" + currentCountry.toLowerCase() + "_" + currentCategory.replace(/\s+/g, '_').toLowerCase() + "_filtered_" + new Date().toISOString().split('T')[0] + ".csv"
      );
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      closeExportModal();
    }

    function testFirebaseURL() {
      if (!window.db) {
        alert('‚ùå Firebase not configured!\n\nPlease update your Firebase configuration in the script section.');
        return;
      }
      alert(
        'üî• Testing Firestore connection...\n\n' +
        '‚úÖ Firebase initialized successfully!\n' +
        'üìä Collections available:\n\n' +
        'üáÆüá≥ INDIA:\n' +
        '- fashion_and_apparel\n- beauty_and_fitness\n- home_and_garden\n- food_and_drink\n- business_and_industrial\n- auto_and_vehicles\n- arts_and_entertainment\n- consumer_electronics\n- finance\n- gifts_and_special_events\n- health\n- jobs_and_education\n- pets_and_animals\n- sports\n- toys_and_hobbies\n- travel\n\n' +
        'üá∫üá∏ USA:\n' +
        '- fashion_and_apparel_usa\n- beauty_and_fitness_usa\n- home_and_garden_usa\n- food_and_drink_usa\n- business_and_industrial_usa\n- auto_and_vehicles_usa\n- arts_and_entertainment_usa\n- consumer_electronics_usa\n- finance_usa\n- gifts_and_special_events_usa\n- health_usa\n- jobs_and_education_usa\n- pets_and_animals_usa\n- sports_usa\n- toys_and_hobbies_usa\n- travel_usa\n\n' +
        'üá¶üá™ UAE:\n' +
        '- fashion_and_apparel_uae\n- beauty_and_fitness_uae\n- home_and_garden_uae\n- food_and_drink_uae\n- business_and_industrial_uae\n- auto_and_vehicles_uae\n- arts_and_entertainment_uae\n- consumer_electronics_uae\n- finance_uae\n- gifts_and_special_events_uae\n- health_uae\n- jobs_and_education_uae\n- pets_and_animals_uae\n- sports_uae\n- toys_and_hobbies_uae\n- travel_uae'
      );
    }

    document.addEventListener('DOMContentLoaded', function() {
      if (!window.db) {
        document.getElementById('statusText').innerHTML =
          '‚ùå Firebase not configured. Please check your configuration.';
        document.getElementById('statusText').className = 'text-sm text-red-600';
        allData = [];
        filteredData = [];
        renderTable();
        updateCountryStats();
      } else {
        setTimeout(() => { loadDataFromFirestore(currentCountry, currentCategory); }, 100);
      }
    });

    document.getElementById('exportModal').addEventListener('click', function(e) {
      if (e.target === this) closeExportModal();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeExportModal();
    });
  </script>
</body>
</html>
