<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Store Leads Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.18.1/clusterize.min.js"></script>
  <style>
    .loading { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .clusterize-scroll { max-height: 600px; overflow-y: auto; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="flex flex-col lg:flex-row min-h-screen">
    <aside class="w-full lg:w-64 bg-white p-4 space-y-6">
      <div>
        <label>Category</label>
        <select id="categorySelect" onchange="changeCategory()" class="w-full p-2 border rounded">
          <option>Fashion & Apparel</option>
          <option>Beauty & Fitness</option>
          <option>Home & Garden</option>
        </select>
      </div>
      <div>
        <label>Search</label>
        <input id="searchInput" oninput="applyFilters()" class="w-full p-2 border rounded" placeholder="Search domain or merchant" />
      </div>
      <div>
        <label>Country</label>
        <select id="filterCountry" onchange="applyFilters()" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label>Platform</label>
        <select id="filterPlatform" onchange="applyFilters()" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label>Status</label>
        <select id="filterStatus" onchange="applyFilters()" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <h3>Visible Columns</h3>
        <div class="space-y-2 max-h-48 overflow-y-auto">
          <label><input type="checkbox" id="col-domain" checked onchange="toggleColumn('domain')" /> Domain</label>
          <!-- add all other column toggles as needed -->
        </div>
      </div>
    </aside>
    <main class="flex-1 flex flex-col">
      <header class="bg-blue-600 text-white p-4 flex justify-between">
        <h1>Store Leads</h1>
        <button onclick="openExportModal()" class="bg-blue-700 px-4 py-2 rounded">Export</button>
      </header>
      <section class="p-6 flex-1">
        <p id="statusText" class="text-green-600 mb-4"></p>
        <div id="loading" class="hidden flex justify-center py-20">
          <div class="loading w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
        </div>
        <div id="dataTable" class="hidden overflow-x-auto bg-white rounded shadow">
          <table class="min-w-full">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th><input type="checkbox" onchange="selectAll(this)" /></th>
                <th class="col-domain">Domain</th>
                <th class="col-merchant_name">Merchant</th>
                <th class="col-city">City</th>
                <th class="col-country_code">Country</th>
                <th class="col-platform">Platform</th>
                <th class="col-status">Status</th>
                <!-- add other <th> here -->
              </tr>
            </thead>
          </table>
          <div id="scrollArea" class="clusterize-scroll">
            <table class="min-w-full clusterize-content">
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
        <nav id="bottomPagination" class="hidden flex justify-center mt-4 space-x-2">
          <button onclick="goToPage(1)">First</button>
          <button onclick="prevPage()">Prev</button>
          <div id="pageNumbers" class="flex space-x-1"></div>
          <button onclick="nextPage()">Next</button>
          <button onclick="goToLastPage()">Last</button>
        </nav>
      </section>
    </main>
  </div>

  <script>
    const config = {
      itemsPerPage: 30,
      thresholdVirtual: 10000,
      categoryFiles: {
        'Fashion & Apparel': '/data/Fashion and Apparel.csv',
        'Beauty & Fitness': '/data/Beauty and Fitness.csv',
        'Home & Garden': '/data/Home and Garden.csv'
      }
    };
    let state = { allData: [], filteredData: [], currentPage: 1, currentCategory: '' };
    let clusterize = null;

    const refs = {
      loading: document.getElementById('loading'),
      dataTable: document.getElementById('dataTable'),
      bottomPagination: document.getElementById('bottomPagination'),
      tableBody: document.getElementById('tableBody'),
      statusText: document.getElementById('statusText')
    };

    function toggleVisibility(elem, show) {
      elem.classList[show ? 'remove' : 'add']('hidden');
    }

    function showLoading() {
      toggleVisibility(refs.loading, true);
      toggleVisibility(refs.dataTable, false);
      toggleVisibility(refs.bottomPagination, false);
    }
    function hideLoading() {
      toggleVisibility(refs.loading, false);
      toggleVisibility(refs.dataTable, true);
      toggleVisibility(refs.bottomPagination, true);
    }

    function loadCategory(category) {
      state.currentCategory = category;
      showLoading();
      refs.statusText.textContent = `Loading ${category}â€¦`;
      Papa.parse(config.categoryFiles[category], {
        download: true,
        header: true,
        worker: true,
        complete: ({ data }) => {
          state.allData = data.map((row, i) => ({ id: i+1, ...row }));
          state.filteredData = [...state.allData];
          state.currentPage = 1;
          hideLoading();
          applyFilters();
        }
      });
    }

    function applyFilters() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      state.filteredData = state.allData.filter(item =>
        item.domain.toLowerCase().includes(term) || item.merchant_name.toLowerCase().includes(term)
      );
      state.currentPage = 1;
      renderView();
    }

    function renderRows(items) {
      return items.map(item =>
        `<tr class="hover:bg-gray-50">` +
        `<td><input type=\"checkbox\"/></td>` +
        `<td class=\"col-domain\">${item.domain}</td>` +
        `<td class=\"col-merchant_name\">${item.merchant_name}</td>` +
        `<td class=\"col-city\">${item.city}</td>` +
        `<td class=\"col-country_code\">${item.country_code}</td>` +
        `<td class=\"col-platform\">${item.platform}</td>` +
        `<td class=\"col-status\">${item.status}</td>` +
        `</tr>`
      ).join('');
    }

    function renderView() {
      if (state.filteredData.length > config.thresholdVirtual) {
        toggleVisibility(refs.bottomPagination, false);
        if (clusterize) clusterize.destroy(true);
        clusterize = new Clusterize({ scrollId: 'scrollArea', contentId: 'tableBody', rows: renderRows(state.filteredData) });
      } else {
        toggleVisibility(refs.bottomPagination, true);
        if (clusterize) { clusterize.destroy(true); clusterize = null; }
        renderTable();
      }
    }

    function renderTable() {
      const start = (state.currentPage - 1) * config.itemsPerPage;
      const page = state.filteredData.slice(start, start + config.itemsPerPage);
      refs.tableBody.innerHTML = renderRows(page);
      renderPagination();
    }

    function renderPagination() {
      const total = Math.ceil(state.filteredData.length / config.itemsPerPage);
      const container = refs.bottomPagination;
      container.innerHTML = '';
      const createBtn = (text, fn) => { const b = document.createElement('button'); b.textContent = text; b.onclick = fn; container.appendChild(b); };
      createBtn('First', () => goToPage(1));
      createBtn('Prev', () => goToPage(state.currentPage - 1));
      for (let i = 1; i <= total; i++) createBtn(i, () => goToPage(i));
      createBtn('Next', () => goToPage(state.currentPage + 1));
      createBtn('Last', () => goToPage(total));
    }

    function goToPage(p) {
      const total = Math.ceil(state.filteredData.length / config.itemsPerPage);
      state.currentPage = Math.max(1, Math.min(p, total));
      renderView();
    }

    function prevPage() { goToPage(state.currentPage - 1); }
    function nextPage() { goToPage(state.currentPage + 1); }
    function selectAll(master) { document.querySelectorAll('#tableBody input[type="checkbox"]').forEach(cb => cb.checked = master.checked); }
    function changeCategory() { loadCategory(document.getElementById('categorySelect').value); }

    document.addEventListener('DOMContentLoaded', () => loadCategory(document.getElementById('categorySelect').value));
  </script>
</body>
</html>
