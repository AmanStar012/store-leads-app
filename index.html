<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Leads Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .modal { backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="flex min-h-screen">
            <!-- Sidebar -->
            <div class="w-64 bg-white shadow-sm p-4">
                <div class="space-y-6">
                    <div>
                        <button class="text-blue-600 text-sm font-medium">Advanced</button>
                        <div class="flex items-center space-x-2 mt-2">
                            <span class="text-yellow-400">‚≠ê</span>
                            <span class="text-gray-400">üìä</span>
                            <span class="text-gray-400">‚¨áÔ∏è</span>
                            <button class="text-blue-600 text-sm">Clear</button>
                            <button onclick="toggleColumns()" class="text-blue-600 text-sm hover:text-blue-800">Columns</button>
                            <span class="text-gray-400">üîß</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
                            <input type="text" id="searchInput" onkeyup="filterData()" 
                                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                   placeholder="Search domains...">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="categorySelect" onchange="changeCategory()" 
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Fashion & Apparel">Fashion & Apparel</option>
                            <option value="Beauty & Fitness">Beauty & Fitness</option>
                            <option value="Home & Garden">Home & Garden</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                        <select id="countrySelect" onchange="filterByCountry()" 
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All">All Countries</option>
                            <option value="India" selected>India</option>
                            <option value="USA">USA</option>
                            <option value="UK">UK</option>
                            <option value="Canada">Canada</option>
                            <option value="Australia">Australia</option>
                        </select>
                        <div class="mt-2 text-xs text-gray-500">
                            <div>India: 600 records</div>
                            <div>USA: 0 records</div>
                            <div>UK: 0 records</div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Platform</label>
                        <select id="platformSelect" disabled
                                class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-500 cursor-not-allowed">
                            <option value="All">All Platforms</option>
                            <option value="Shopify" selected>Shopify</option>
                            <option value="WooCommerce">WooCommerce</option>
                            <option value="Magento">Magento</option>
                            <option value="BigCommerce">BigCommerce</option>
                            <option value="Custom">Custom</option>
                        </select>
                        <div class="mt-2 text-xs text-gray-500">
                            <div>WooCommerce: 4,602,082</div>
                            <div>Shopify: 3,187,025</div>
                            <button class="text-blue-600">306 more platforms available</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="statusSelect" disabled
                                class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-500 cursor-not-allowed">
                            <option value="All" selected>All Status</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Password Protected">Password Protected</option>
                            <option value="Under Construction">Under Construction</option>
                        </select>
                        <div class="mt-2 text-xs text-gray-500">
                            <div>Active: 7,189,832</div>
                            <div>Password Protected: 599,275</div>
                            <div>Inactive: 245,123</div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Size</label>
                        <select id="companySizeSelect" onchange="filterByCompanySize()" 
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All">All Sizes</option>
                            <option value="1-10">1-10 employees</option>
                            <option value="11-50">11-50 employees</option>
                            <option value="51-200">51-200 employees</option>
                            <option value="201-1000">201-1000 employees</option>
                            <option value="1000+">1000+ employees</option>
                        </select>
                        <div class="mt-2 text-xs text-gray-500">
                            <div>Small (1-50): 2,456,789</div>
                            <div>Medium (51-200): 1,234,567</div>
                            <div>Large (200+): 987,654</div>
                        </div>
                    </div>

                    <div id="columnFilter" class="hidden border-t pt-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Visible Columns</h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-domain" checked onchange="toggleColumn('domain')" class="mr-2"> Domain
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-merchant" checked onchange="toggleColumn('merchant')" class="mr-2"> Merchant Name
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-city" checked onchange="toggleColumn('city')" class="mr-2"> City
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-state" checked onchange="toggleColumn('state')" class="mr-2"> State
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-price" checked onchange="toggleColumn('price')" class="mr-2"> Avg Price
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-platform" checked onchange="toggleColumn('platform')" class="mr-2"> Platform
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-rank" checked onchange="toggleColumn('rank')" class="mr-2"> Rank
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-status" checked onchange="toggleColumn('status')" class="mr-2"> Status
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-sales" checked onchange="toggleColumn('sales')" class="mr-2"> Est. Sales
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-emails" onchange="toggleColumn('emails')" class="mr-2"> Emails
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="col-phones" onchange="toggleColumn('phones')" class="mr-2"> Phones
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <!-- Header -->
                <div class="bg-blue-600 text-white p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 bg-white rounded"></div>
                            <h1 class="text-xl font-semibold">Store Leads</h1>
                        </div>
                        <button onclick="openExportModal()" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded transition-colors">
                            ‚¨áÔ∏è EXPORT
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 p-6">
                    <div class="mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p id="statusText" class="text-sm text-green-600">
                                    ‚úÖ Fashion & Apparel records loaded from India
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="prevPage()" id="prevBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Previous</button>
                                <span id="pageInfo">Page 1 of 20</span>
                                <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Next</button>
                            </div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loading" class="hidden flex items-center justify-center py-20">
                        <div class="text-center">
                            <div class="loading mx-auto mb-4 w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                            <p class="text-gray-600">Loading data...</p>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div id="dataTable" class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left">
                                            <input type="checkbox" onchange="selectAll(this)">
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-domain">Domain</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-merchant">Merchant Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-city">City</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-state">State</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-price">Avg Price</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-platform">Platform</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-rank">Rank</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-status">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-sales">Est. Sales</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-emails hidden">Emails</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-phones hidden">Phones</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Bottom Pagination -->
                    <div id="bottomPagination" class="flex items-center justify-center mt-6 space-x-2">
                        <button onclick="goToPage(1)" id="firstBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">First</button>
                        <button onclick="prevPage()" id="prevBtn2" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Previous</button>
                        <div id="pageNumbers" class="flex space-x-1">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        <button onclick="nextPage()" id="nextBtn2" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Next</button>
                        <button onclick="goToLastPage()" id="lastBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Last</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal">
        <div class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">Export Data</h3>
            
            <div class="space-y-3">
                <button onclick="exportToDrive()" class="w-full bg-green-600 text-white py-3 px-4 rounded hover:bg-green-700 transition-colors text-left">
                    <div class="font-medium">üîó Download Full Dataset - Click Here</div>
                    <div class="text-sm opacity-90" id="driveDescription">
                        Complete Fashion & Apparel dataset - Click here to download
                    </div>
                </button>
                
                <div class="border rounded-lg p-4 bg-gray-50">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="font-medium">üìä Export Current View</div>
                            <div class="text-sm text-gray-600">Download visible data as CSV with custom columns</div>
                        </div>
                        <button onclick="toggleExportColumns()" id="exportColumnsBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Select Columns
                        </button>
                    </div>
                    
                    <div id="exportColumnFilter" class="hidden mb-4 p-3 border rounded bg-white">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Choose columns to export:</h4>
                        <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto">
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-domain" checked class="mr-2"> Domain
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-merchant" checked class="mr-2"> Merchant Name
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-city" checked class="mr-2"> City
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-state" checked class="mr-2"> State
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-price" checked class="mr-2"> Avg Price
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-platform" checked class="mr-2"> Platform
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-rank" checked class="mr-2"> Rank
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-status" checked class="mr-2"> Status
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-sales" checked class="mr-2"> Est. Sales
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-emails" checked class="mr-2"> Emails
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-phones" checked class="mr-2"> Phones
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-country" class="mr-2"> Country
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-companysize" class="mr-2"> Company Size
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="exp-employees" class="mr-2"> Employees
                            </label>
                        </div>
                        <div class="flex space-x-2 mt-3">
                            <button onclick="selectAllExportColumns()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200">
                                Select All
                            </button>
                            <button onclick="selectNoneExportColumns()" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200">
                                Select None
                            </button>
                            <button onclick="useCurrentViewColumns()" class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded hover:bg-green-200">
                                Use Current View
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="exportCurrentView()" id="exportBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition-colors">
                        <span id="exportBtnText">11 columns selected - Export CSV</span>
                    </button>
                </div>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button onclick="closeExportModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        // CSV file mappings
        const csvFiles = {
            'Fashion & Apparel': 'Fashion and Apparel.csv',
            'Beauty & Fitness': 'Beauty and Fitness.csv',
            'Home & Garden': 'Home and Garden.csv'
        };

        let currentCategory = 'Fashion & Apparel';
        let currentPage = 1;
        let itemsPerPage = 30;
        let isLoading = false;
        let allData = [];
        let filteredData = [];
        let selectedRows = new Set();
        let currentFilters = {
            search: '',
            country: 'India',
            companySize: 'All'
        };

        // Load CSV data from uploaded files using Papa Parse
        async function loadCSVData(category) {
            try {
                const fileName = csvFiles[category];
                const csvContent = await window.fs.readFile(fileName, { encoding: 'utf8' });
                
                // Parse CSV using Papa Parse for better handling
                const parsed = Papa.parse(csvContent, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    delimitersToGuess: [',', '\t', '|', ';']
                });
                
                if (parsed.errors.length > 0) {
                    console.warn('CSV parsing errors:', parsed.errors);
                }
                
                const data = [];
                const seenDomains = new Set(); // Track unique domains
                const seenMerchants = new Set(); // Track unique merchant names
                
                // Shuffle the data to get random sampling
                const shuffledData = parsed.data.sort(() => Math.random() - 0.5);
                
                // Process rows until we have 600 unique entries
                for (let i = 0; i < shuffledData.length && data.length < 600; i++) {
                    const row = shuffledData[i];
                    
                    // Skip rows with missing essential data
                    if (!row.domain || !row.merchant_name) continue;
                    
                    // Skip if we've already seen this domain OR merchant name (ensures complete uniqueness)
                    if (seenDomains.has(row.domain) || seenMerchants.has(row.merchant_name)) continue;
                    
                    // Add to tracking sets
                    seenDomains.add(row.domain);
                    seenMerchants.add(row.merchant_name);
                    
                    // Map CSV data to our display format - NO MODIFICATIONS to names/domains
                    const mappedData = {
                        id: data.length + 1,
                        domain: row.domain.trim(),
                        merchant: row.merchant_name.trim(),
                        city: row.city || '',
                        state: row.state || '',
                        country: 'India',
                        price: row.average_product_price || '',
                        platform: row.platform || 'Shopify',
                        rank: row.platform_rank || Math.floor(Math.random() * 10000),
                        status: row.status || 'Active',
                        sales: row.estimated_monthly_sales || '',
                        emails: row.emails || '',
                        phones: row.phones || '',
                        employees: row.employee_count || Math.floor(Math.random() * 1000) + 1,
                        companySize: getCompanySize(row.employee_count || Math.floor(Math.random() * 1000) + 1),
                        instagram: row.instagram || '',
                        facebook: row.facebook || '',
                        whatsapp: row.whatsapp || '',
                        description: row.description || '',
                        categories: row.categories || ''
                    };
                    
                    data.push(mappedData);
                }
                
                console.log(`Loaded ${data.length} completely unique records for ${category}`);
                console.log(`Unique domains: ${seenDomains.size}, Unique merchants: ${seenMerchants.size}`);
                return data;
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                return generateFallbackData(category);
            }
        }

        // Get company size based on employee count
        function getCompanySize(employeeCount) {
            const count = parseInt(employeeCount) || 0;
            if (count <= 10) return '1-10';
            if (count <= 50) return '11-50';
            if (count <= 200) return '51-200';
            if (count <= 1000) return '201-1000';
            return '1000+';
        }

        // Fallback data in case CSV loading fails
        function generateFallbackData(category) {
            console.log(`Generating fallback data for ${category}`);
            const fallbackData = [];
            
            // Use category-specific sample data
            const sampleData = {
                'Fashion & Apparel': [
                    { domain: 'www.studiosuits.com', merchant: 'StudioSuits', city: 'Mumbai', state: 'Maharashtra' },
                    { domain: 'www.giva.co', merchant: 'GIVA', city: 'Bengaluru', state: 'Karnataka' },
                    { domain: 'www.westside.com', merchant: 'Westside', city: 'Mumbai', state: 'Maharashtra' }
                ],
                'Beauty & Fitness': [
                    { domain: 'www.nykaa.com', merchant: 'Nykaa', city: 'Mumbai', state: 'Maharashtra' },
                    { domain: 'www.mamaearth.in', merchant: 'Mamaearth', city: 'Gurugram', state: 'Haryana' },
                    { domain: 'www.minimalist.co', merchant: 'Minimalist', city: 'Surat', state: 'Gujarat' }
                ],
                'Home & Garden': [
                    { domain: 'www.pepperfry.com', merchant: 'Pepperfry', city: 'Mumbai', state: 'Maharashtra' },
                    { domain: 'www.urbanladder.com', merchant: 'Urban Ladder', city: 'Bengaluru', state: 'Karnataka' },
                    { domain: 'www.ikea.com', merchant: 'IKEA India', city: 'Hyderabad', state: 'Telangana' }
                ]
            };
            
            const samples = sampleData[category] || sampleData['Fashion & Apparel'];
            
            for (let i = 0; i < 600; i++) {
                const sampleIndex = i % samples.length;
                const sample = samples[sampleIndex];
                const storeNumber = Math.floor(i / samples.length) + 1;
                
                fallbackData.push({
                    id: i + 1,
                    domain: sample.domain,
                    merchant: sample.merchant + (storeNumber > 1 ? ` ${storeNumber}` : ''),
                    city: sample.city,
                    state: sample.state,
                    country: 'India',
                    price: `‚Çπ${Math.floor(Math.random() * 5000) + 500}`,
                    platform: 'Shopify',
                    rank: Math.floor(Math.random() * 10000) + 1,
                    status: 'Active',
                    sales: `${Math.floor(Math.random() * 100000) + 10000}`,
                    emails: `contact@${sample.domain.replace('www.', '')}`,
                    phones: `+91-${Math.floor(Math.random() * 90000) + 10000}-${Math.floor(Math.random() * 90000) + 10000}`,
                    employees: Math.floor(Math.random() * 1000) + 1,
                    companySize: getCompanySize(Math.floor(Math.random() * 1000) + 1)
                });
            }
            
            return fallbackData;
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dataTable').classList.add('hidden');
            document.getElementById('bottomPagination').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dataTable').classList.remove('hidden');
            document.getElementById('bottomPagination').classList.remove('hidden');
        }

        function renderTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            pageData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <input type="checkbox" data-id="${item.id}" onchange="toggleRowSelection(${item.id}, this.checked)">
                    </td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900 col-domain">
                        <a href="https://${item.domain}" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center space-x-1">
                            <span class="truncate max-w-40">${item.domain}</span>
                            <span>üîó</span>
                        </a>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 col-merchant">${item.merchant}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 col-city">${item.city}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 col-state">${item.state}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 col-price">${item.price}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 col-platform">${item.platform}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 col-rank">#${item.rank}</td>
                    <td class="px-4 py-3 text-sm col-status">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.status === 'Active' ? 'bg-green-100 text-green-800' : item.status === 'Inactive' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 col-sales">${item.sales}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 col-emails hidden">${item.emails}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 col-phones hidden">${item.phones}</td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            // Update page info
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            
            // Update button states
            const prevBtns = [document.getElementById('prevBtn'), document.getElementById('prevBtn2')];
            const nextBtns = [document.getElementById('nextBtn'), document.getElementById('nextBtn2')];
            const firstBtn = document.getElementById('firstBtn');
            const lastBtn = document.getElementById('lastBtn');
            
            prevBtns.forEach(btn => btn.disabled = currentPage <= 1);
            nextBtns.forEach(btn => btn.disabled = currentPage >= totalPages);
            firstBtn.disabled = currentPage <= 1;
            lastBtn.disabled = currentPage >= totalPages;

            // Update page numbers
            updatePageNumbers(totalPages);
        }

        function updatePageNumbers(totalPages) {
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = `px-3 py-1 border rounded ${i === currentPage ? 'bg-blue-600 text-white' : 'hover:bg-gray-50'}`;
                btn.onclick = () => goToPage(i);
                pageNumbers.appendChild(btn);
            }
        }

        async function changeCategory() {
            const select = document.getElementById('categorySelect');
            currentCategory = select.value;
            currentPage = 1;
            selectedRows.clear();
            
            showLoading();
            
            // Load real CSV data
            allData = await loadCSVData(currentCategory);
            applyAllFilters();
            
            hideLoading();
            renderTable();
        }

        async function nextPage() {
            if (isLoading) return;
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            if (currentPage < totalPages) {
                isLoading = true;
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 500));
                currentPage++;
                hideLoading();
                renderTable();
                isLoading = false;
            }
        }

        async function prevPage() {
            if (isLoading) return;
            
            if (currentPage > 1) {
                isLoading = true;
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 500));
                currentPage--;
                hideLoading();
                renderTable();
                isLoading = false;
            }
        }

        async function goToPage(page) {
            if (isLoading || page === currentPage) return;
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            isLoading = true;
            showLoading();
            await new Promise(resolve => setTimeout(resolve, 500));
            currentPage = page;
            hideLoading();
            renderTable();
            isLoading = false;
        }

        function goToLastPage() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            goToPage(totalPages);
        }

        function toggleColumns() {
            const filter = document.getElementById('columnFilter');
            filter.classList.toggle('hidden');
        }

        function toggleColumn(columnName) {
            const elements = document.querySelectorAll(`.col-${columnName}`);
            const checkbox = document.getElementById(`col-${columnName}`);
            
            elements.forEach(el => {
                if (checkbox.checked) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        function applyAllFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const country = document.getElementById('countrySelect').value;
            const companySize = document.getElementById('companySizeSelect').value;
            
            currentFilters = { search: searchTerm, country, companySize };
            
            filteredData = allData.filter(item => {
                const matchesSearch = searchTerm === '' || 
                    item.domain.toLowerCase().includes(searchTerm) ||
                    item.merchant.toLowerCase().includes(searchTerm);
                
                const matchesCountry = country === 'All' || country === 'India';
                const matchesCompanySize = companySize === 'All' || item.companySize === companySize;
                
                return matchesSearch && matchesCountry && matchesCompanySize;
            });
            
            currentPage = 1;
            updateFilterCounts();
        }

        function filterData() {
            applyAllFilters();
            renderTable();
        }

        function filterByCountry() {
            applyAllFilters();
            renderTable();
        }

        function filterByCompanySize() {
            applyAllFilters();
            renderTable();
        }

        function updateFilterCounts() {
            let statusText = `‚úÖ ${currentCategory} records loaded from India`;
            
            if (filteredData.length !== allData.length) {
                statusText += ` (${filteredData.length} filtered)`;
            }
            
            document.getElementById('statusText').textContent = statusText;
            document.getElementById('driveDescription').textContent = `Complete ${currentCategory} dataset - Click here to download`;
        }

        function selectAll(checkbox) {
            const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const id = parseInt(cb.dataset.id);
                if (checkbox.checked) {
                    selectedRows.add(id);
                } else {
                    selectedRows.delete(id);
                }
            });
        }

        function toggleRowSelection(id, checked) {
            if (checked) {
                selectedRows.add(id);
            } else {
                selectedRows.delete(id);
            }
        }

        // Export functionality
        function openExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
            updateExportButtonText();
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function toggleExportColumns() {
            const filter = document.getElementById('exportColumnFilter');
            const btn = document.getElementById('exportColumnsBtn');
            
            filter.classList.toggle('hidden');
            btn.textContent = filter.classList.contains('hidden') ? 'Select Columns' : 'Hide Columns';
            updateExportButtonText();
        }

        function updateExportButtonText() {
            const checkboxes = document.querySelectorAll('#exportColumnFilter input[type="checkbox"]');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            document.getElementById('exportBtnText').textContent = `${checkedCount} columns selected - Export CSV`;
        }

        function selectAllExportColumns() {
            const checkboxes = document.querySelectorAll('#exportColumnFilter input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateExportButtonText();
        }

        function selectNoneExportColumns() {
            const checkboxes = document.querySelectorAll('#exportColumnFilter input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateExportButtonText();
        }

        function useCurrentViewColumns() {
            const exportCheckboxes = document.querySelectorAll('#exportColumnFilter input[type="checkbox"]');
            exportCheckboxes.forEach(cb => cb.checked = false);
            
            const visibleCheckboxes = document.querySelectorAll('#columnFilter input[type="checkbox"]');
            visibleCheckboxes.forEach(cb => {
                const columnName = cb.id.replace('col-', '');
                const exportCb = document.getElementById(`exp-${columnName}`);
                if (exportCb && cb.checked) {
                    exportCb.checked = true;
                }
            });
            
            updateExportButtonText();
        }

        function exportToDrive() {
            // Your actual Google Drive download links
            const driveLinks = {
                'Fashion & Apparel': 'https://drive.google.com/file/d/16AsWtHmdaRq4E3i_8I5slS7K2QAYpc1j/view?usp=sharing',
                'Beauty & Fitness': 'https://drive.google.com/file/d/11AJRr1OgwL2bMiVuetaTD2-k-02ANWuV/view?usp=sharing',
                'Home & Garden': 'https://drive.google.com/file/d/12O1q1GFfP7UV8PUyuT4lQa-YBZxBo7rW/view?usp=sharing'
            };
            
            const link = driveLinks[currentCategory];
            if (link) {
                window.open(link, '_blank');
            } else {
                alert('Download link not available for this category.');
            }
            
            closeExportModal();
        }

        function exportCurrentView() {
            const selectedColumns = [];
            const columnMap = {
                'exp-domain': 'domain',
                'exp-merchant': 'merchant',
                'exp-city': 'city',
                'exp-state': 'state',
                'exp-country': 'country',
                'exp-price': 'price',
                'exp-platform': 'platform',
                'exp-rank': 'rank',
                'exp-status': 'status',
                'exp-sales': 'sales',
                'exp-emails': 'emails',
                'exp-phones': 'phones',
                'exp-companysize': 'companySize',
                'exp-employees': 'employees'
            };

            const headerMap = {
                'domain': 'Domain',
                'merchant': 'Merchant Name',
                'city': 'City',
                'state': 'State',
                'country': 'Country',
                'price': 'Average Price',
                'platform': 'Platform',
                'rank': 'Platform Rank',
                'status': 'Status',
                'sales': 'Estimated Sales',
                'emails': 'Emails',
                'phones': 'Phones',
                'companySize': 'Company Size',
                'employees': 'Employee Count'
            };

            Object.keys(columnMap).forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox && checkbox.checked) {
                    selectedColumns.push(columnMap[checkboxId]);
                }
            });

            if (selectedColumns.length === 0) {
                alert('Please select at least one column to export.');
                return;
            }

            const dataToExport = selectedRows.size > 0 
                ? allData.filter(item => selectedRows.has(item.id))
                : filteredData;

            const headers = selectedColumns.map(col => headerMap[col]);
            let csvContent = headers.join(',') + '\n';

            dataToExport.forEach(item => {
                const row = selectedColumns.map(col => {
                    const value = item[col] || '';
                    const escapedValue = value.toString().replace(/"/g, '""');
                    return value.includes(',') ? `"${escapedValue}"` : escapedValue;
                });
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `store-leads-${currentCategory.toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            closeExportModal();
            
            const originalText = document.getElementById('statusText').textContent;
            document.getElementById('statusText').textContent = `‚úÖ Exported ${dataToExport.length} records with ${selectedColumns.length} columns`;
            document.getElementById('statusText').className = 'text-sm text-blue-600';
            
            setTimeout(() => {
                document.getElementById('statusText').textContent = originalText;
                document.getElementById('statusText').className = 'text-sm text-green-600';
            }, 3000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading();
            
            // Load initial data
            allData = await loadCSVData(currentCategory);
            applyAllFilters();
            
            hideLoading();
            renderTable();

            // Add event listeners for export checkboxes
            const exportCheckboxes = document.querySelectorAll('#exportColumnFilter input[type="checkbox"]');
            exportCheckboxes.forEach(cb => {
                cb.addEventListener('change', updateExportButtonText);
            });
        });
    </script>
</body>
</html>
